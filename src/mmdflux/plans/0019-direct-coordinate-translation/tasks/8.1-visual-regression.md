# Task 8.1: Visual Regression Validation

## Objective
Run all fixtures through both old and new pipelines, compare outputs, and categorize every difference.

## Location
Modify: `tests/integration.rs`

---

## Implementation

Add a test that renders every fixture with both `compute_layout_dagre()` and `compute_layout_direct()`, reporting differences:

```rust
#[test]
fn compare_old_vs_new_all_fixtures() {
    use std::fs;
    use mmdflux::render::layout::{compute_layout_dagre, compute_layout_direct, LayoutConfig};

    let fixture_dir = Path::new(env!("CARGO_MANIFEST_DIR")).join("tests").join("fixtures");

    let mut diffs = Vec::new();
    let mut identical = Vec::new();

    for entry in fs::read_dir(&fixture_dir).unwrap() {
        let path = entry.unwrap().path();
        if path.extension().map_or(false, |e| e == "mmd") {
            let name = path.file_stem().unwrap().to_str().unwrap().to_string();
            let input = fs::read_to_string(&path).unwrap();
            let flowchart = parse_flowchart(&input).expect("parse failed");
            let diagram = build_diagram(&flowchart);

            let old_output = render_with_layout(&diagram, compute_layout_dagre);
            let new_output = render_with_layout(&diagram, compute_layout_direct);

            if old_output == new_output {
                identical.push(name);
            } else {
                diffs.push(name);
            }
        }
    }

    eprintln!("\n=== IDENTICAL ({}) ===", identical.len());
    for name in &identical {
        eprintln!("  {}", name);
    }
    eprintln!("\n=== DIFFERENT ({}) ===", diffs.len());
    for name in &diffs {
        eprintln!("  {}", name);
    }

    // This test always passes — it's diagnostic output.
    // After review, convert expected-identical fixtures into assertions.
}
```

**Note:** The `render_with_layout` helper will need to be created — a variant of `render()` that accepts a layout function. Alternatively, render both by constructing Layout directly and passing to the renderer.

### After reviewing output, add assertion tests:

For each fixture categorized as "should be identical or improved":

```rust
#[test]
fn direct_simple_matches_or_improves() {
    let old = render_fixture_with_old("simple.mmd");
    let new = render_fixture_with_new("simple.mmd");
    // For linear diagrams, output should be identical
    assert_eq!(old, new, "simple.mmd should be identical between pipelines");
}
```

### Categorization guide:

| Category | Action | Examples |
|----------|--------|---------|
| **Identical** | Assert equality | `simple.mmd`, `chain.mmd` |
| **Improved** | Update baseline snapshot, assert new output | Fan patterns with better `edge_sep` spacing |
| **Neutral shift** | Accept if <=2 char shift, update snapshot | Minor rounding differences |
| **Regression** | File as task 8.2 bug | Overlapping nodes, broken edges |

## Acceptance Criteria
- [ ] All 26+ fixtures rendered with both pipelines
- [ ] Differences categorized (identical / improved / neutral / regression)
- [ ] No regressions in node overlap, edge routing, or label placement
- [ ] Categorization documented (eprintln output or in a report)
