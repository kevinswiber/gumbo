# Task 7.1–7.3: Backward-Edge Overlap Prevention (TDD)

## Objective
Write a test proving that the direct translation pipeline preserves the cross-axis offsets that prevent backward-edge overlap — the key property that `compute_stagger_positions()` was originally introduced to solve.

## Location
Modify: `tests/integration.rs`

---

## RED — Write failing test asserting stagger preservation (7.1)

This test should pass with the Green implementation from Phase 6. If it fails, Phase 7 GREEN fixes the issue. The point of writing it as RED first is to verify the *test itself* is meaningful — it should fail against a naive implementation that centers all layers.

### Test:

```rust
#[test]
fn direct_preserves_backward_edge_stagger() {
    // multiple_cycles.mmd has backward edges that create dummy chains.
    // dagre's BK produces distinct cross-axis offsets for nodes involved.
    // The direct pipeline should preserve these offsets (not center layers).
    //
    // Property: nodes in layers with backward-edge dummies should NOT all
    // share the same cross-axis center position.
    let diagram = parse_and_build("multiple_cycles.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    // Collect x-centers for all real nodes (not dummies, which aren't in Layout)
    let x_centers: Vec<usize> = layout.node_bounds.values()
        .map(|b| b.center_x())
        .collect();

    // At least two nodes should have different x-centers
    // (if all centers are identical, the pipeline is centering layers and
    // discarding dagre's BK offsets, which causes overlap)
    let min_x = x_centers.iter().copied().min().unwrap();
    let max_x = x_centers.iter().copied().max().unwrap();
    assert!(
        max_x > min_x,
        "all node centers are at x={} — backward-edge stagger was lost",
        min_x,
    );
}

#[test]
fn direct_cycle_no_edge_overlap_at_attachment() {
    // simple_cycle.mmd: A→B→C→A has a backward edge C→A.
    // The backward edge and forward edge at node A should attach at
    // different points (not the same column), verified by checking that
    // the waypoints for the backward edge are distinct from the
    // waypoints of the forward edge.
    let diagram = parse_and_build("simple_cycle.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    // Verify layout has waypoints (backward edges go through dummy nodes)
    // The key assertion: no two edges share identical waypoint sequences
    let wp_vecs: Vec<&Vec<(usize, usize)>> = layout.edge_waypoints.values().collect();
    for i in 0..wp_vecs.len() {
        for j in (i + 1)..wp_vecs.len() {
            if !wp_vecs[i].is_empty() && !wp_vecs[j].is_empty() {
                assert_ne!(
                    wp_vecs[i], wp_vecs[j],
                    "two edges share identical waypoint paths — overlap likely"
                );
            }
        }
    }
}
```

### Run and confirm:
```bash
cargo test direct_preserves_backward -- --nocapture
cargo test direct_cycle_no_edge_overlap -- --nocapture
```

**Expected outcome:** These tests should pass if Phase 6 was implemented correctly, because direct translation inherently preserves dagre's BK offsets. If they fail, proceed to GREEN.

---

## GREEN — Fix if needed (7.2)

The direct translation pipeline should inherently preserve backward-edge stagger because:
- dagre's BK produces distinct cross-axis positions for nodes in layers with backward-edge dummy chains
- The formula `(dagre_center - dagre_min) * scale` preserves relative offsets proportionally
- Unlike the old pipeline, direct translation does **not** center layers independently

If the tests fail, the likely cause is:
1. **Collision repair over-centering** — collision repair pushes nodes apart but might align them. Fix: ensure repair only pushes right/down, never recenters.
2. **Scale factor too aggressive** — very small scale factors might round distinct dagre positions to the same integer. Fix: add a minimum gap in the rounding step.

---

## REFACTOR — Commit (7.3)

- Confirm `cargo test` passes
- Commit: `feat(plan-0019): Phase 7 - Backward-edge overlap prevention verified`

## Context

See research documents:
- [stagger-preservation-analysis.md](../../../research/archive/0009-attachment-point-spreading/stagger-preservation-analysis.md) — original problem description
- [synthesis.md (0010)](../../../research/archive/0010-attachment-spreading-revisited/synthesis.md) — follow-up analysis

The old pipeline lost dagre's offsets because `compute_grid_positions()` assigned sequential integers within each layer and centering placed single-node layers at the same center. Direct translation avoids this by never discarding dagre's relative positions.

## Acceptance Criteria
- [ ] Both tests pass
- [ ] Backward-edge nodes have distinct cross-axis positions
- [ ] No identical waypoint paths between different edges
- [ ] `cargo clippy` clean
