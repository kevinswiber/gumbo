# Task 8.2: Fix Regressions (TDD per regression)

## Objective
For each regression identified in task 8.1, apply TDD: write a test that captures the regression, then fix it.

## Location
Modify: `src/render/layout.rs`, `tests/integration.rs`

---

## Process (per regression)

### RED
Write a test for the specific fixture that asserts the correct property (e.g., no overlap, label visible, edge connected):

```rust
#[test]
fn direct_regression_FIXTURE_NAME_PROPERTY() {
    let diagram = parse_and_build("fixture_name.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    // Assert the specific property that regressed
    // e.g., node A should be above node B, or no overlaps, etc.
}
```

Run test â€” confirm it fails against the current implementation.

### GREEN
Fix the minimal code in `compute_layout_direct()` or its component functions to make the test pass.

### REFACTOR
Clean up, ensure all other tests still pass.

---

## Common Regression Patterns and Fixes

### Nodes too close / overlapping
- **Test:** Assert `min_gap` between all adjacent node bounds
- **Fix:** Adjust collision repair `min_gap` or scale factor cross-axis formula

### Canvas too wide/tall
- **Test:** Assert canvas dimensions are within a reasonable multiple of the old pipeline's dimensions
- **Fix:** Normalize positions to minimize origin offset; adjust scale factor

### Waypoints misaligned with nodes
- **Test:** Assert waypoints at a given rank have the same primary-axis coordinate as nodes in that rank (within tolerance)
- **Fix:** Ensure `layer_starts` computation matches actual node positions after collision repair

### LR/RL vertical spacing wrong
- **Test:** Compare vertical gap between nodes in LR fixture vs expected `v_spacing`
- **Fix:** Adjust cross-axis scale for horizontal layouts; tune direction-aware `node_sep`

### Labels overlapping nodes
- **Test:** Assert label position does not fall within any node's bounding box
- **Fix:** Add label-specific offset or collision avoidance post-scaling

## Acceptance Criteria
- [ ] Each regression has a failing test before the fix
- [ ] Each fix makes only its test pass without breaking others
- [ ] All tests pass after all fixes
- [ ] `cargo clippy` clean
- [ ] Commit: `feat(plan-0019): Phase 8 - Fix visual regressions`
