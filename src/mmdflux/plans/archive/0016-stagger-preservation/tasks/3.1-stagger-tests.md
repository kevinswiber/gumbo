# Task 3.1: Add Stagger Integration Tests

## Objective

Add integration tests verifying that stagger is present when backward edges exist and absent when they don't.

## Location

Add tests to: `tests/integration.rs` or `src/render/layout.rs` (mod tests)

## Implementation

### Test: Stagger present for multiple_cycles.mmd

```rust
#[test]
fn test_stagger_preservation_multiple_cycles() {
    // multiple_cycles.mmd: A[Top] --> B[Middle], B --> C[Bottom], C --> A, C --> B
    // Dagre computes: A at x=41.75 (right), B at x=16.75 (left), C at x=15.0 (left)
    // After stagger preservation: A's center_x should be > B's and C's center_x
    let diagram = parse_and_build("tests/fixtures/multiple_cycles.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout(&diagram, &config);

    let a_bounds = &layout.node_bounds["A"];
    let b_bounds = &layout.node_bounds["B"];
    let c_bounds = &layout.node_bounds["C"];

    // A should be staggered right of B and C
    assert!(
        a_bounds.center_x() > b_bounds.center_x(),
        "A (center_x={}) should be right of B (center_x={})",
        a_bounds.center_x(), b_bounds.center_x()
    );
    assert!(
        a_bounds.center_x() > c_bounds.center_x(),
        "A (center_x={}) should be right of C (center_x={})",
        a_bounds.center_x(), c_bounds.center_x()
    );
}
```

### Test: No stagger for simple chain

```rust
#[test]
fn test_no_stagger_simple_chain() {
    // chain.mmd: A --> B --> C --> D (no backward edges)
    // Dagre computes all nodes at same x → no stagger
    let diagram = parse_and_build("tests/fixtures/chain.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout(&diagram, &config);

    // All nodes should have the same center_x (centered)
    let centers: Vec<usize> = layout.node_bounds.values()
        .map(|b| b.center_x())
        .collect();
    let first = centers[0];
    for &c in &centers[1..] {
        assert!(
            (c as isize - first as isize).unsigned_abs() <= 1,
            "All nodes should be centered: got {:?}", centers
        );
    }
}
```

### Test: Different attachment points after stagger

```rust
#[test]
fn test_stagger_produces_different_attachment_points() {
    // For multiple_cycles.mmd, the forward edge A→B and backward edge C→A
    // should attach at different positions on node A's boundary.
    let diagram = parse_and_build("tests/fixtures/multiple_cycles.mmd");
    let config = LayoutConfig::default();
    let layout = compute_layout(&diagram, &config);
    let routed = route_all_edges(&diagram.edges, &layout, diagram.direction);

    // Find edges that share node A
    let a_b_edge = routed.iter().find(|e| e.from == "A" && e.to == "B").unwrap();
    let c_a_edge = routed.iter().find(|e| e.from == "C" && e.to == "A").unwrap();

    // A→B exits from A; C→A enters A — should be at different positions
    let a_b_source = a_b_edge.segments.first().unwrap().start;
    let c_a_target = c_a_edge.segments.last().unwrap().end;

    assert_ne!(
        a_b_source, c_a_target,
        "Forward and backward edges should attach at different points on A"
    );
}
```

## Context

- The exact assertion values will need adjustment based on the actual scale factor chosen in task 1.2.
- Helper function `parse_and_build()` may need to be added or an existing test helper used.
- Node IDs in fixtures may vary — check actual fixture content.

## Acceptance Criteria

- [ ] Test verifying stagger for backward-edge diagrams
- [ ] Test verifying no stagger for simple diagrams
- [ ] Test verifying different attachment points result from stagger
- [ ] All tests pass
