# Task 1.4: Integrate Stagger Into grid_to_draw_horizontal()

## Objective

Modify `grid_to_draw_horizontal()` to use dagre's staggered cross-axis positions for LR/RL layouts. Mirrors the changes from task 1.3 but for the cross axis being Y instead of X.

## Location

Modify: `src/render/layout.rs` â€” `grid_to_draw_horizontal()` (lines ~744-856) and its call site.

## Implementation

### Add parameter

```rust
fn grid_to_draw_horizontal(
    grid_positions: &HashMap<String, GridPos>,
    node_dims: &HashMap<String, (usize, usize)>,
    layers: &[Vec<String>],
    _layer_widths: &[usize],
    config: &LayoutConfig,
    reverse: bool,
    stagger_centers: &HashMap<String, usize>, // NEW: dagre stagger positions (cross-axis = Y)
) -> HorizontalLayoutResult {
```

### Modify node positioning loop (lines ~802-847)

Same pattern as task 1.3 but:
- Cross axis is Y (vertical position within each column)
- `stagger_centers` contains Y-center positions
- Node x comes from `layer_x_starts[layer_idx]` (unchanged)
- Node y comes from stagger center minus half height

```rust
    if !stagger_centers.is_empty() && sorted_nodes.iter().any(|id| stagger_centers.contains_key(*id)) {
        // Stagger mode
        for node_id in &sorted_nodes {
            if let Some(&(w, h)) = node_dims.get(*node_id) {
                let layer_width = max_layer_widths[layer_idx];
                let node_x = layer_x_starts[layer_idx] + (layer_width - w) / 2;
                let node_y = stagger_centers
                    .get(*node_id)
                    .map(|&center| center.saturating_sub(h / 2))
                    .unwrap_or_else(|| {
                        config.padding + (max_column_content_height.saturating_sub(h)) / 2
                    });
                draw_positions.insert((*node_id).clone(), (node_x, node_y));
                node_bounds.insert(
                    (*node_id).clone(),
                    NodeBounds { x: node_x, y: node_y, width: w, height: h },
                );
            }
        }
    } else {
        // Original centering logic (unchanged)
        // ... existing code ...
    }
```

### Update call site

```rust
    // In the match arm for LeftRight | RightLeft:
    let stagger_positions = compute_stagger_positions(
        &layers,
        &dagre_cross_positions,
        &node_dims,
        |d| d.1, // height for LR/RL (cross axis = Y)
        config.v_spacing,
        config.padding,
        0, // no label margin on cross axis for LR/RL
    );

    let result = grid_to_draw_horizontal(
        &grid_positions,
        &node_dims,
        &layers,
        &layer_widths,
        config,
        diagram.direction == Direction::RightLeft,
        &stagger_positions,
    );
```

### Update canvas_height

```rust
    let actual_max_y = node_bounds.values()
        .map(|b| b.y + b.height)
        .max()
        .unwrap_or(0);
    let canvas_height = actual_max_y + config.padding;
```

## Context

- For LR/RL layouts, the primary axis is X (columns) and the cross axis is Y (vertical position within columns).
- Stagger in LR/RL means nodes shift up/down within their columns.
- The non-dagre `compute_layout()` path also calls `grid_to_draw_horizontal()` and should pass an empty HashMap.

## Acceptance Criteria

- [ ] `grid_to_draw_horizontal()` accepts stagger_centers parameter
- [ ] Stagger mode positions nodes using Y-centers from dagre
- [ ] Non-stagger mode unchanged
- [ ] Canvas height accounts for stagger offsets
- [ ] LR/RL fixtures render correctly
