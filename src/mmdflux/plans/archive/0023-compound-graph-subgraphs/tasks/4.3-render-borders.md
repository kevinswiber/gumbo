# Task 4.3: Implement render_subgraph_borders

## Objective

Draw subgraph border rectangles on the canvas BEFORE nodes render, using box-drawing characters. Place title label above the top-left corner. Mark cells as `is_subgraph_border`.

## Location

New function in `src/render/shape.rs` or new `src/render/subgraph.rs`

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_render_subgraph_border_characters() {
    let mut canvas = Canvas::new(20, 10);
    let bounds = SubgraphBounds { x: 2, y: 3, width: 10, height: 5, title: "Group".to_string() };
    let mut map = HashMap::new();
    map.insert("sg1".to_string(), bounds);
    let charset = CharSet::unicode();

    render_subgraph_borders(&mut canvas, &map, &charset);

    // Verify corners
    assert_eq!(canvas.get(2, 3).ch, charset.corner_tl);
    assert_eq!(canvas.get(11, 3).ch, charset.corner_tr);
    assert_eq!(canvas.get(2, 7).ch, charset.corner_bl);
    assert_eq!(canvas.get(11, 7).ch, charset.corner_br);

    // Verify edges
    assert_eq!(canvas.get(5, 3).ch, charset.horizontal);
    assert_eq!(canvas.get(2, 5).ch, charset.vertical);

    // Verify is_subgraph_border flag
    assert!(canvas.get(2, 3).is_subgraph_border);
}

#[test]
fn test_render_subgraph_title() {
    let mut canvas = Canvas::new(20, 10);
    let bounds = SubgraphBounds { x: 2, y: 3, width: 10, height: 5, title: "Group".to_string() };
    let mut map = HashMap::new();
    map.insert("sg1".to_string(), bounds);

    render_subgraph_borders(&mut canvas, &map, &CharSet::unicode());

    // Title should appear above the border (y - 1)
    assert_eq!(canvas.get(2, 2).ch, 'G');
    assert_eq!(canvas.get(3, 2).ch, 'r');
}

#[test]
fn test_render_subgraph_ascii_mode() {
    let mut canvas = Canvas::new(20, 10);
    let bounds = SubgraphBounds { x: 2, y: 3, width: 10, height: 5, title: "Test".to_string() };
    let mut map = HashMap::new();
    map.insert("sg1".to_string(), bounds);

    render_subgraph_borders(&mut canvas, &map, &CharSet::ascii());

    assert_eq!(canvas.get(2, 3).ch, '+');
    assert_eq!(canvas.get(5, 3).ch, '-');
    assert_eq!(canvas.get(2, 5).ch, '|');
}
```

**What the failing test asserts:** Border characters drawn correctly in Unicode and ASCII modes; title placed above border; cells flagged.
**Expected failure reason:** `render_subgraph_borders` function does not exist.

### Green: Minimal Implementation

```rust
pub fn render_subgraph_borders(
    canvas: &mut Canvas,
    subgraph_bounds: &HashMap<String, SubgraphBounds>,
    charset: &CharSet,
) {
    for (_, bounds) in subgraph_bounds {
        // Draw title above top-left
        if bounds.y > 0 {
            for (i, ch) in bounds.title.chars().enumerate() {
                canvas.set_char(bounds.x + i, bounds.y - 1, ch);
            }
        }

        // Draw border rectangle
        let x = bounds.x;
        let y = bounds.y;
        let w = bounds.width;
        let h = bounds.height;

        // Top edge
        canvas.set_subgraph_border(x, y, charset.corner_tl);
        for dx in 1..w - 1 {
            canvas.set_subgraph_border(x + dx, y, charset.horizontal);
        }
        canvas.set_subgraph_border(x + w - 1, y, charset.corner_tr);

        // Sides
        for dy in 1..h - 1 {
            canvas.set_subgraph_border(x, y + dy, charset.vertical);
            canvas.set_subgraph_border(x + w - 1, y + dy, charset.vertical);
        }

        // Bottom edge
        canvas.set_subgraph_border(x, y + h - 1, charset.corner_bl);
        for dx in 1..w - 1 {
            canvas.set_subgraph_border(x + dx, y + h - 1, charset.horizontal);
        }
        canvas.set_subgraph_border(x + w - 1, y + h - 1, charset.corner_br);
    }
}
```

Add `set_subgraph_border` helper to Canvas:
```rust
pub fn set_subgraph_border(&mut self, x: usize, y: usize, ch: char) {
    if x < self.width && y < self.height {
        self.cells[y][x].ch = ch;
        self.cells[y][x].is_subgraph_border = true;
    }
}
```

### Refactor: Clean Up

- Consider whether CharSet needs separate subgraph border characters (thin vs thick lines)
- Ensure bounds checking for edge cases (title overflow, border at canvas edge)
- Extract `draw_border_rect` as a reusable helper

## Context

- Terminal rendering has no z-order; subgraph borders must render BEFORE nodes/edges
- Cells marked `is_subgraph_border` are NOT protected (unlike `is_node`)
- Title placement: above top-left corner (Mermaid convention)
- Reference: [Q6 research](../../../research/0016-compound-graph-subgraphs/q6-rendering-pipeline-changes.md)

## Acceptance Criteria

- [ ] Failing tests written and confirmed red
- [ ] Border rectangles drawn with correct box-drawing characters
- [ ] Title rendered above the border
- [ ] ASCII mode uses +/-/|
- [ ] Cells flagged as `is_subgraph_border`
- [ ] Tests pass
