# Task 5.1: Update Integration Tests with Subgraph Fixtures

## Objective

Add integration tests that render all subgraph fixtures and verify output quality, including snapshot tests.

## Location

Modify: `tests/integration.rs`

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_render_simple_subgraph() {
    let input = std::fs::read_to_string("tests/fixtures/simple_subgraph.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions::default());

    // Should contain subgraph title
    assert!(output.contains("Process"));
    // Should contain node labels
    assert!(output.contains("Start"));
    assert!(output.contains("Middle"));
    assert!(output.contains("End"));
    // Should not panic
}

#[test]
fn test_render_subgraph_edges() {
    let input = std::fs::read_to_string("tests/fixtures/subgraph_edges.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions::default());

    assert!(output.contains("Input"));
    assert!(output.contains("Output"));
    assert!(output.contains("Data"));
    assert!(output.contains("Result"));
}

#[test]
fn test_render_multi_subgraph() {
    let input = std::fs::read_to_string("tests/fixtures/multi_subgraph.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions::default());

    assert!(output.contains("Frontend"));
    assert!(output.contains("Backend"));
}

#[test]
fn test_render_subgraph_ascii_mode() {
    let input = std::fs::read_to_string("tests/fixtures/simple_subgraph.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions { ascii_only: true, ..Default::default() });

    // ASCII mode should use +/-/| for borders
    assert!(output.contains('+'));
    assert!(output.contains('-'));
}

#[test]
fn test_existing_fixtures_unchanged() {
    // Render all existing fixtures and verify they haven't changed
    // This is the key regression test
    let fixtures = ["simple.mmd", "chain.mmd", "fan_in.mmd", "fan_out.mmd"];
    for fixture in fixtures {
        let input = std::fs::read_to_string(format!("tests/fixtures/{}", fixture)).unwrap();
        let flowchart = parse_flowchart(&input).unwrap();
        let diagram = build_diagram(&flowchart);
        let output = render(&diagram, &RenderOptions::default());
        // Verify output is non-empty and doesn't contain unexpected border characters
        assert!(!output.is_empty());
    }
}
```

**What the failing test asserts:** All subgraph fixtures render correctly; existing fixtures unchanged.
**Expected failure reason:** Tests will pass once all previous phases are complete.

### Green: Minimal Implementation

The tests should pass with no additional code changes if all previous tasks are complete. If any fixtures produce unexpected output, adjust layout padding or border rendering.

### Refactor: Clean Up

- Consider adding snapshot/insta tests for visual regression
- Verify output quality manually for the first iteration
- Add comments explaining what each fixture tests

## Context

- Integration tests verify the full parse -> build -> layout -> render pipeline
- These tests serve as both feature validation and regression prevention
- Existing fixture tests MUST continue to pass (compound logic is gated)

## Acceptance Criteria

- [ ] All subgraph fixture integration tests added
- [ ] All fixtures render without panics
- [ ] Subgraph titles and borders visible in output
- [ ] ASCII mode tested
- [ ] Existing fixture tests pass unchanged
