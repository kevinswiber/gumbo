# Task 2.2: Wire Subgraph Info from Diagram to DiGraph

## Objective

When building the DiGraph for layout, pass subgraph membership as parent relationships and add compound (subgraph) nodes to the graph.

## Location

Modify: `src/render/layout.rs` (where `compute_layout_direct` builds the DiGraph)

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_layout_digraph_has_compound_nodes_for_subgraph_diagram() {
    let input = "graph TD\nsubgraph sg1[Group]\nA --> B\nend\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);

    // Build the DiGraph (may need to expose an internal helper for testing)
    // Verify has_compound_nodes() is true
    // Verify parent("A") == "sg1"
}

#[test]
fn test_layout_simple_diagram_no_compound() {
    let input = "graph TD\nA --> B\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);

    // Verify has_compound_nodes() is false
}
```

**What the failing test asserts:** DiGraph built from a Diagram with subgraphs has correct parent relationships.
**Expected failure reason:** `compute_layout_direct` doesn't add subgraph nodes or set parents on DiGraph.

### Green: Minimal Implementation

In `compute_layout_direct`, after adding regular nodes to the DiGraph:

```rust
// Add subgraph nodes as compound nodes (zero dimensions, sized later by border removal)
for (sg_id, _sg) in &diagram.subgraphs {
    graph.add_node(sg_id.as_str(), (0.0, 0.0));
}

// Set parent relationships
for (node_id, node) in &diagram.nodes {
    if let Some(ref parent) = node.parent {
        graph.set_parent(node_id.as_str(), parent.as_str());
    }
}
```

### Refactor: Clean Up

- Ensure subgraph nodes are added before parent relationships are set
- Verify the zero-dimension subgraph nodes don't affect existing layout for simple graphs

## Context

- `compute_layout_direct` in `src/render/layout.rs` constructs a `DiGraph` from `Diagram` and calls `dagre::layout()`
- Subgraph nodes are added with zero dimensions; their actual size is determined by border removal in Phase B
- Reference: [Q4 research](../../../research/0016-compound-graph-subgraphs/q4-graph-layer-design.md)

## Acceptance Criteria

- [ ] Failing tests written and confirmed red
- [ ] DiGraph includes subgraph compound nodes
- [ ] Parent relationships set correctly
- [ ] Simple diagrams unaffected (no compound nodes)
- [ ] All existing layout tests pass
