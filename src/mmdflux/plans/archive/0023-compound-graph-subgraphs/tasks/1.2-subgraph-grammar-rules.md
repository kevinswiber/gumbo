# Task 1.2: Add Subgraph Grammar Rules

## Objective

Add PEG grammar rules for `subgraph ... end` blocks to the pest grammar, supporting `subgraph id[title]` and `subgraph id` forms.

## Location

Modify: `src/parser/grammar.pest`

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_parse_subgraph_with_title() {
    let input = "graph TD\nsubgraph sg1[My Group]\nA --> B\nend\n";
    let result = parse_flowchart(input);
    assert!(result.is_ok(), "Failed to parse subgraph with title: {:?}", result.err());
}

#[test]
fn test_parse_subgraph_without_title() {
    let input = "graph TD\nsubgraph sg1\nA --> B\nend\n";
    let result = parse_flowchart(input);
    assert!(result.is_ok(), "Failed to parse subgraph without title: {:?}", result.err());
}

#[test]
fn test_parse_subgraph_with_external_nodes() {
    let input = "graph TD\nsubgraph sg1[Group]\nA --> B\nend\nC --> A\n";
    let result = parse_flowchart(input);
    assert!(result.is_ok(), "Failed to parse subgraph with external nodes: {:?}", result.err());
}
```

**What the failing test asserts:** The parser accepts `subgraph ... end` syntax in all supported forms.
**Expected failure reason:** Grammar has no `subgraph_stmt` rule; parser rejects the input.

### Green: Minimal Implementation

Add to `src/parser/grammar.pest`:

```pest
// Subgraph support
subgraph_keyword = { ^"subgraph" }
end_keyword = { ^"end" }

subgraph_id = @{ (ASCII_ALPHA | "_") ~ (ASCII_ALPHANUMERIC | "_" | "-")* }
subgraph_title_text = @{ (!"]" ~ ANY)+ }
subgraph_title_bracket = { "[" ~ subgraph_title_text ~ "]" }
subgraph_spec = { subgraph_id ~ subgraph_title_bracket? }

subgraph_stmt = {
    subgraph_keyword ~ WHITESPACE+ ~ subgraph_spec ~ NEWLINE ~
    ((statement | comment) ~ NEWLINE?)* ~
    end_keyword
}
```

Update `statement` rule:
```pest
statement = { subgraph_stmt | vertex_statement }
```

**Key considerations:**
- `subgraph_stmt` must come BEFORE `vertex_statement` in the `statement` rule so pest tries it first
- `end` keyword could conflict with node IDs -- the `subgraph_keyword` prefix disambiguates the block structure
- `subgraph_id` allows alphanumeric, underscores, and hyphens (consistent with node identifiers)

### Refactor: Clean Up

- Ensure grammar rules are organized near other keyword rules
- Verify WHITESPACE handling is consistent with existing rules
- Test edge cases: subgraph with no nodes, subgraph followed immediately by another subgraph

## Context

- Current grammar: `statement = { vertex_statement }` with no block structure support
- pest PEG is right-recursive; `statement*` within `subgraph_stmt` handles nesting naturally
- Reference: [Q3 research](../../../research/0016-compound-graph-subgraphs/q3-parser-extension-design.md)

## Acceptance Criteria

- [ ] Failing test written and confirmed red
- [ ] Grammar rules added for subgraph_stmt, subgraph_spec, subgraph_keyword, end_keyword
- [ ] `statement` rule updated to include `subgraph_stmt | vertex_statement`
- [ ] All three test cases pass
- [ ] Existing parser tests pass unchanged
