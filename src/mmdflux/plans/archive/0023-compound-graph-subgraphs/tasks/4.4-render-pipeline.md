# Task 4.4: Wire Subgraph Rendering into Render Pipeline

## Objective

Insert subgraph border rendering between canvas creation and node rendering in `render()`.

## Location

Modify: `src/render/mod.rs`

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_render_with_subgraph_produces_borders() {
    let input = "graph TD\nsubgraph sg1[Group]\nA --> B\nend\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions::default());

    // Output should contain border characters
    assert!(output.contains('┌') || output.contains('+'));
    assert!(output.contains('┘') || output.contains('+'));
    // Output should contain the title
    assert!(output.contains("Group"));
}

#[test]
fn test_render_simple_diagram_unchanged() {
    let input = "graph TD\nA --> B\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let output = render(&diagram, &RenderOptions::default());

    // Should not contain subgraph border artifacts
    // Should match existing expected output
}
```

**What the failing test asserts:** Full end-to-end rendering includes subgraph borders and title; simple diagrams unchanged.
**Expected failure reason:** `render()` doesn't call `render_subgraph_borders`.

### Green: Minimal Implementation

In `render()` in `src/render/mod.rs`, add the subgraph border pass:

```rust
pub fn render(diagram: &Diagram, options: &RenderOptions) -> String {
    let charset = /* select charset */;
    let layout = compute_layout_direct(diagram, &config);
    let mut canvas = Canvas::new(layout.width, layout.height);

    // NEW: Render subgraph borders FIRST (z-order: background)
    if !layout.subgraph_bounds.is_empty() {
        render_subgraph_borders(&mut canvas, &layout.subgraph_bounds, &charset);
    }

    // Render nodes (overwrites border cells where they overlap)
    // ... existing node rendering ...

    // Route and render edges
    // ... existing edge rendering ...

    canvas.to_string()
}
```

### Refactor: Clean Up

- Ensure the conditional check avoids any work for simple diagrams
- Verify the render order: borders -> nodes -> edges
- Check that the `render_subgraph_borders` import is clean

## Context

- This is the final integration point: connecting layout output to visual rendering
- The render pass order is critical for z-ordering on the character grid
- Simple diagrams must produce identical output (the check on `subgraph_bounds.is_empty()` ensures this)

## Acceptance Criteria

- [ ] Failing tests written and confirmed red
- [ ] Subgraph border render pass inserted before node rendering
- [ ] End-to-end test shows borders and title in output
- [ ] Simple diagrams produce identical output
- [ ] All existing render tests pass
