# Task 3.2: BK borderType Guard in Pass 2

## Objective

In the BK algorithm's horizontal compaction Pass 2 (pull-right), prevent border nodes from being pulled past their intended side.

## Location

Modify: `src/dagre/bk.rs`

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_bk_border_guard_prevents_left_border_pull_right() {
    // Build a compound graph where Pass 2 would pull a left border node rightward
    // Verify the guard prevents this
    let mut lg = build_compound_graph_for_bk_test();
    // Set up border_type for border nodes

    position::run(&mut lg, &config);

    // Left border node should remain at or left of its expected position
    let left_border_idx = lg.border_left[&sg1_idx][0];
    let leftmost_child_x = /* min x of non-border children */;
    assert!(lg.xs[left_border_idx] <= leftmost_child_x);
}

#[test]
fn test_bk_simple_graph_unchanged() {
    // Run BK on a simple graph (no border nodes)
    // Verify output is identical to current behavior
    let mut lg = build_simple_layout_graph();
    // ... run full pipeline
    // Compare xs output with known-good values
}
```

**What the failing test asserts:** Border nodes aren't displaced by Pass 2 pull-right; simple graphs unaffected.
**Expected failure reason:** BK has no borderType check; border nodes get pulled to wrong positions.

### Green: Minimal Implementation

In `src/dagre/bk.rs`, in the Pass 2 horizontal compaction loop:

```rust
// After computing min from successors:
if min.is_finite() {
    // borderType guard: don't pull border nodes past their intended side
    let should_pull = if let Some(&bt) = lg.border_type.get(&elem) {
        match bt {
            // Left borders should not be pulled rightward in left-biased alignments
            // Right borders should not be pulled rightward in right-biased alignments
            BorderType::Left => false,  // conservative: never pull left borders right
            BorderType::Right => true,  // right borders can be pulled right
        }
    } else {
        true // non-border nodes: pull as normal
    };

    if should_pull {
        xs[elem] = xs[elem].max(min);
    }
}
```

### Refactor: Clean Up

- Refine the guard condition based on the specific alignment direction (UL, UR, DL, DR)
- The guard should be vacuous (always true) when `lg.border_type` is empty (simple graphs)
- Consider adding a comment referencing dagre.js's implementation for future reference

## Context

- BK algorithm computes four alignments (UL, UR, DL, DR) and takes the median
- Pass 2 pulls nodes rightward toward their block graph successors
- Without the guard, left border nodes can be pulled right, breaking the bounding box
- Reference: [Q5 research](../../../research/0016-compound-graph-subgraphs/q5-dagre-pipeline-changes.md), prior research on BK borderType guard

## Acceptance Criteria

- [ ] Failing tests written and confirmed red
- [ ] borderType guard prevents inappropriate border node displacement
- [ ] Simple graphs (empty border_type map) unaffected
- [ ] All existing BK/position tests pass
