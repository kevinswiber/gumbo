# Task 5.1-5.4: Testing and Validation

## Objective

Validate the Brandes-Köpf implementation produces correct and improved layouts.

## 5.1: Test with complex.mmd

### Procedure

```bash
# Before implementation (save current output)
cargo run -q -- ./tests/fixtures/complex.mmd > /tmp/complex-before.txt

# After implementation
cargo run -q -- ./tests/fixtures/complex.mmd > /tmp/complex-after.txt

# Compare
diff /tmp/complex-before.txt /tmp/complex-after.txt
```

### Expected Improvements

1. **Node positioning**: Nodes should be positioned to minimize edge crossings and length
2. **E→F edge**: May route more cleanly due to better node positioning
3. **Overall compactness**: Layout width should be minimized

### Visual Inspection

Check that:
- All nodes still visible and correctly shaped
- All edges connect to correct nodes
- Labels positioned correctly
- No overlapping elements

## 5.2: Integration Test Updates

### Run all tests

```bash
cargo test --test integration
```

### For each failure

1. Generate new expected output
2. Compare old vs new visually
3. If new is better or equivalent: update expectation
4. If new is worse: investigate bug

### Expected changes

Brandes-Köpf may reposition nodes horizontally, which could change:
- Edge paths (different start/end x coordinates)
- Overall diagram width
- Node positioning within layers

## 5.3: Visual Review

### Review script

```bash
#!/bin/bash
for fixture in tests/fixtures/*.mmd; do
    echo "=== $fixture ==="
    cargo run -q -- "$fixture"
    echo "---"
    read -p "Press enter to continue"
done
```

### Checklist per fixture

- [ ] `simple.mmd` - Basic diagram renders correctly
- [ ] `chain.mmd` - Linear chain aligned vertically
- [ ] `decision.mmd` - Branching structure balanced
- [ ] `complex.mmd` - Complex diagram improved or equivalent
- [ ] `shapes.mmd` - All shapes render correctly
- [ ] `labeled_edges.mmd` - Labels positioned correctly
- [ ] `edge_styles.mmd` - All stroke styles work
- [ ] `left_right.mmd` - LR direction works
- [ ] `right_left.mmd` - RL direction works
- [ ] `bottom_top.mmd` - BT direction works
- [ ] `simple_cycle.mmd` - Backward edges still work
- [ ] `multiple_cycles.mmd` - Multiple backward edges work

## 5.4: Performance Benchmarking

### Benchmark setup

```rust
// In benches/layout.rs (or create if doesn't exist)

use criterion::{criterion_group, criterion_main, Criterion};
use mmdflux::dagre::{layout, LayoutConfig};

fn benchmark_layout(c: &mut Criterion) {
    let complex_diagram = include_str!("../tests/fixtures/complex.mmd");
    let diagram = parse_and_build(complex_diagram);

    c.bench_function("layout_complex", |b| {
        b.iter(|| layout(&diagram, &LayoutConfig::default()))
    });
}

fn benchmark_large_diagram(c: &mut Criterion) {
    // Generate a large diagram
    let large_diagram = generate_large_diagram(100, 10);  // 100 nodes, 10 layers

    c.bench_function("layout_large", |b| {
        b.iter(|| layout(&large_diagram, &LayoutConfig::default()))
    });
}

criterion_group!(benches, benchmark_layout, benchmark_large_diagram);
criterion_main!(benches);
```

### Run benchmarks

```bash
cargo bench
```

### Performance targets

| Metric | Target | Notes |
|--------|--------|-------|
| simple.mmd | < 1ms | Baseline |
| complex.mmd | < 10ms | Realistic diagram |
| 100 nodes | < 100ms | Large diagram |
| 1000 nodes | < 1s | Stress test |

### If performance regresses

1. Profile with `cargo flamegraph`
2. Identify hotspots
3. Consider caching or algorithmic improvements
4. Document tradeoffs

## Test Matrix

| Test | Purpose | Pass Criteria |
|------|---------|---------------|
| Unit: conflict detection | Correctness | All conflict cases detected |
| Unit: vertical alignment | Correctness | Blocks formed correctly |
| Unit: compaction | Correctness | Separation maintained |
| Unit: balance | Correctness | Median computed correctly |
| Integration: all fixtures | No regression | All pass or improved |
| Visual: all fixtures | Quality | No visual defects |
| Performance: benchmarks | Speed | Within targets |

## Acceptance Criteria

- [ ] complex.mmd renders with improved or equivalent layout
- [ ] All integration tests pass (with updated expectations)
- [ ] Visual review shows no regressions
- [ ] Performance within acceptable bounds
- [ ] No new warnings or errors
