# Task 5.1: Sort Subgraphs by Nesting Depth Before Rendering

## Objective
Ensure outer borders are drawn first (background) and inner borders are drawn last (foreground) for proper visual layering of nested subgraph borders.

## Location
Modify: `src/render/subgraph.rs` â€” modify `render_subgraph_borders()`
Modify: `src/render/layout.rs` â€” add `depth` field to `SubgraphBounds`

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_nested_borders_inner_visible() {
    let input = "graph TD\nsubgraph outer[Outer]\nA\nsubgraph inner[Inner]\nB --> C\nend\nend\nA --> B\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let output = render(&diagram, &config);
    // Both border titles should be visible
    assert!(output.contains("Outer"), "Output should contain 'Outer' title");
    assert!(output.contains("Inner"), "Output should contain 'Inner' title");
}
```

**What the failing test asserts:** Both inner and outer border titles are visible in the rendered output.
**Expected failure reason:** Without z-order control, HashMap iteration order is undefined and inner borders may be overwritten by outer border drawing.

### ðŸŸ¢ Green: Minimal Implementation

1. Add `pub depth: usize` to `SubgraphBounds`:
```rust
pub struct SubgraphBounds {
    pub x: usize,
    pub y: usize,
    pub width: usize,
    pub height: usize,
    pub title: String,
    pub depth: usize,  // NEW: nesting depth (0 = top-level)
}
```

2. Populate `depth` during bounds computation in `convert_subgraph_bounds`:
```rust
// After computing bounds for a subgraph:
let depth = diagram.subgraph_depth(sg_id);
```
Or compute depth from the parent chain within the bounds computation.

3. In `render_subgraph_borders`, sort by depth before rendering:
```rust
let mut sorted_bounds: Vec<_> = subgraph_bounds.iter().collect();
sorted_bounds.sort_by_key(|(_, b)| b.depth);
for (_, bounds) in sorted_bounds {
    // existing border drawing logic
}
```

### ðŸ”µ Refactor: Clean Up

Update all `SubgraphBounds` construction sites to include `depth: 0` for single-level subgraphs.

## Context
The canvas draws characters sequentially. Without ordering, border characters from one subgraph can overwrite another. By drawing outer (depth=0) first and inner (depth=1+) last, inner borders are always visible.

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] `SubgraphBounds` has `depth` field
- [ ] Borders are rendered in depth order (outer first, inner last)
- [ ] Inner border corners and titles are visible (not overwritten)
- [ ] Single-level subgraphs unaffected (depth=0)
- [ ] Code refactored with tests still green
