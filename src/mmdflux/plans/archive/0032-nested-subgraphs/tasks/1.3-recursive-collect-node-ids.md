# Task 1.3: Make `collect_node_ids` Recurse into Nested Subgraphs

## Objective
Ensure outer subgraphs include transitive descendant node IDs in their `nodes` list, so bounds computation does not skip outer subgraphs that contain only nested subgraphs.

## Location
Modify: `src/graph/builder.rs` (lines 82-98, `collect_node_ids` function)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_nested_subgraph_outer_contains_inner_nodes() {
    let input = "graph TD\nsubgraph outer[Outer]\nsubgraph inner[Inner]\nA --> B\nend\nend\n";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    // outer should contain transitive descendants A, B
    assert!(diagram.subgraphs["outer"].nodes.contains(&"A".to_string()));
    assert!(diagram.subgraphs["outer"].nodes.contains(&"B".to_string()));
    // inner should contain its direct nodes A, B
    assert!(diagram.subgraphs["inner"].nodes.contains(&"A".to_string()));
    assert!(diagram.subgraphs["inner"].nodes.contains(&"B".to_string()));
}
```

**What the failing test asserts:** Outer subgraph's `nodes` includes all transitive descendant node IDs.
**Expected failure reason:** `collect_node_ids` returns `vec![]` for `Statement::Subgraph` (line 89), so outer subgraph gets no nodes from nested subgraphs.

### ðŸŸ¢ Green: Minimal Implementation

Change line 89 from:
```rust
Statement::Subgraph(_) => vec![],
```
to:
```rust
Statement::Subgraph(sg) => collect_node_ids(&sg.statements),
```

### ðŸ”µ Refactor: Clean Up

None expected. The deduplication via `HashSet` in `collect_node_ids` already handles any duplicate node IDs.

## Context
`collect_node_ids` extracts node IDs from a statement list for populating the `Subgraph.nodes` field. It currently handles `Vertex` and `Edge` but returns empty for `Subgraph`. The recursive call makes outer subgraphs include all descendant nodes, which is needed for bounds computation.

Note: This means `nodes` loses the distinction between direct and transitive descendants. The `parent` field (Task 1.2) provides the hierarchy information for downstream stages that need it.

See [Q1: Builder parent tracking](../../../research/0025-nested-subgraphs/q1-builder-parent-tracking.md) for research context.

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] Outer subgraph `nodes` includes all transitive descendant node IDs
- [ ] Inner subgraph `nodes` includes its own direct node IDs
- [ ] Deduplication works correctly
- [ ] Code refactored with tests still green
