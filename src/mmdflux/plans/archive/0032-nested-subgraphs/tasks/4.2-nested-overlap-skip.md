# Task 4.2: Skip Nested Pairs in Overlap Resolution

## Objective
Modify `resolve_subgraph_overlap()` to skip pairs where one subgraph is an ancestor of the other. Only apply trimming to sibling pairs.

## Location
Modify: `src/render/layout.rs` â€” modify `resolve_subgraph_overlap()`

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_overlap_resolution_skips_nested_pairs() {
    // Create nested subgraph bounds where outer contains inner
    let mut bounds = HashMap::new();
    bounds.insert("outer".to_string(), SubgraphBounds {
        x: 0, y: 0, width: 20, height: 10,
        title: "Outer".to_string(), depth: 0,
    });
    bounds.insert("inner".to_string(), SubgraphBounds {
        x: 2, y: 2, width: 16, height: 6,
        title: "Inner".to_string(), depth: 1,
    });
    let subgraphs = /* construct subgraphs with inner.parent = Some("outer") */;
    resolve_subgraph_overlap(&mut bounds, &subgraphs);
    // Nested pair should NOT be trimmed
    let outer = &bounds["outer"];
    let inner = &bounds["inner"];
    assert!(outer.x <= inner.x);
    assert!(outer.y <= inner.y);
    assert!(outer.x + outer.width >= inner.x + inner.width);
    assert!(outer.y + outer.height >= inner.y + inner.height);
}
```

**What the failing test asserts:** Overlap resolution does not trim nested pairs; parent still fully contains child.
**Expected failure reason:** Current `resolve_subgraph_overlap` treats all overlapping pairs equally and may trim the outer border.

### ðŸŸ¢ Green: Minimal Implementation

Update `resolve_subgraph_overlap` to accept a `subgraphs` parameter and check for ancestry:

```rust
fn resolve_subgraph_overlap(
    bounds: &mut HashMap<String, SubgraphBounds>,
    subgraphs: &HashMap<String, crate::graph::Subgraph>,
) {
    let ids: Vec<String> = bounds.keys().cloned().collect();
    for i in 0..ids.len() {
        for j in (i + 1)..ids.len() {
            // Skip nested pairs
            if is_ancestor(&ids[i], &ids[j], subgraphs)
                || is_ancestor(&ids[j], &ids[i], subgraphs)
            {
                continue;
            }
            // Existing overlap trimming logic for sibling pairs...
        }
    }
}
```

Update the call site in `convert_subgraph_bounds` to pass `subgraphs`.

### ðŸ”µ Refactor: Clean Up

The function signature change propagates to the call site. Ensure the call site passes the right data.

## Context
See [Q3: Rendering nested bounds](../../../research/0025-nested-subgraphs/q3-rendering-nested-bounds.md) for design rationale. Nested pairs have a containment relationship; trimming them would break the visual containment.

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] Nested pairs (parent-child) are not trimmed
- [ ] Sibling pairs continue to be trimmed as before
- [ ] All existing overlap resolution behavior preserved
- [ ] Code refactored with tests still green
