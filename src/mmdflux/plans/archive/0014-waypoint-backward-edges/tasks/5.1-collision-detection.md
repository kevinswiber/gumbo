# Task 5.1: Add Waypoint-Node Collision Detection

## Objective

Add a post-processing step that detects waypoints colliding with node bounding boxes and nudges them to avoid overlap. This is a safety net — dagre's ordering algorithm should prevent most collisions, but edge cases exist (e.g., very wide nodes at an intermediate rank).

## Location

Modify: `src/render/layout.rs` — inside `compute_layout_dagre()`, after the waypoint conversion loop (after `edge_waypoints_converted` is fully populated).

## Implementation

Add this code block after the waypoint conversion loop and before the `Layout { ... }` constructor:

```rust
// Post-process: nudge waypoints that collide with node bounding boxes.
// Dagre's ordering should prevent this in most cases, but wide nodes
// can occasionally overlap with waypoint positions.
for (_key, waypoints) in &mut edge_waypoints_converted {
    for wp in waypoints.iter_mut() {
        for bounds in node_bounds.values() {
            let (wp_x, wp_y) = *wp;

            // Check if waypoint falls within a node's bounding box
            let collides = wp_x >= bounds.x
                && wp_x < bounds.x + bounds.width
                && wp_y >= bounds.y
                && wp_y < bounds.y + bounds.height;

            if collides {
                // Nudge waypoint to just past the right edge of the node
                // (for vertical layouts) or just below the node (for horizontal)
                if is_vertical {
                    wp.0 = bounds.x + bounds.width + 1;
                } else {
                    wp.1 = bounds.y + bounds.height + 1;
                }
                // Only handle first collision per waypoint
                break;
            }
        }
    }
}
```

## Context

- `node_bounds` is `HashMap<String, NodeBounds>` already computed at this point
- `NodeBounds` has fields `x, y, width, height` (all `usize`)
- `edge_waypoints_converted` is `HashMap<(String, String), Vec<(usize, usize)>>`
- `is_vertical` distinguishes TD/BT from LR/RL

The nudge direction is chosen to push the waypoint to the right (TD/BT) or below (LR/RL), which is the most natural direction for backward edge waypoints since dagre tends to place them to the side of nodes.

A more sophisticated approach would check both directions and choose the closer non-colliding position, or check the dagre coordinate to determine which side of the node the waypoint was intended to be on. For now, the simple rightward/downward nudge is sufficient as a safety net.

## Acceptance Criteria

- [ ] Waypoints that fall inside node bounding boxes are nudged outside
- [ ] Non-colliding waypoints are unchanged
- [ ] `cargo test` passes
- [ ] Manual inspection of `simple_cycle.mmd` and `complex.mmd` shows no waypoints overlapping nodes
