# Task 3.2: Wire `route_all_edges()` to Use Attachment Plan

## Objective

Integrate the attachment plan pre-pass into `route_all_edges()`, passing overrides to each `route_edge()` call.

## Location

Modify: `src/render/router.rs`

## Implementation

```rust
pub fn route_all_edges(
    edges: &[Edge],
    layout: &Layout,
    diagram_direction: Direction,
) -> Vec<RoutedEdge> {
    // Pre-pass: compute attachment plan for edges sharing a face
    let plan = compute_attachment_plan(edges, layout);

    edges
        .iter()
        .enumerate()
        .filter_map(|(i, edge)| {
            let (src_override, tgt_override) = plan
                .get(&i)
                .map(|ov| (ov.source, ov.target))
                .unwrap_or((None, None));
            route_edge(edge, layout, diagram_direction, src_override, tgt_override)
        })
        .collect()
}
```

## Context

- The public API signature of `route_all_edges()` remains **unchanged**. No callers need modification.
- The `Layout` struct already contains `node_shapes` and `node_bounds`, so `compute_attachment_plan()` does not need a `&Diagram` parameter.
- Check how `route_all_edges()` currently iterates edges â€” it may use `.iter().filter_map()` or a for loop. Adapt the plan variable integration accordingly.
- The `plan.get(&i)` lookup returns `None` for edges that don't have overrides (single-edge faces), which correctly passes `(None, None)` to `route_edge()`.
- After this task, the full pipeline is live. Run `cargo run -q -- tests/fixtures/double_skip.mmd` and compare output to verify spreading is working.

## Acceptance Criteria

- [ ] `route_all_edges()` calls `compute_attachment_plan()` before routing
- [ ] Each edge receives its source and target overrides from the plan
- [ ] Edges without overrides (single-edge faces) pass `(None, None)` to `route_edge()`
- [ ] `cargo test` passes
- [ ] Visual verification: `cargo run -q -- tests/fixtures/double_skip.mmd` shows separated arrows on the End node
- [ ] Visual verification: `cargo run -q -- tests/fixtures/fan_in.mmd` shows separated arrows on the Target node
