# Task 2.3: Run all integration tests, update expectations as needed

## Objective

Run the full integration test suite and update any test expectations that change due to synthetic waypoint routing.

## Procedure

### 1. Run all tests

```bash
cargo test --test integration
```

### 2. Identify failures

Failures will be due to expected output changes. These are expected for diagrams with large horizontal offsets.

### 3. Review each failure

For each failing test:

1. **Run the specific test to see the diff:**
   ```bash
   cargo test --test integration test_name -- --nocapture
   ```

2. **Generate new output:**
   ```bash
   cargo run -q -- tests/fixtures/failing_test.mmd
   ```

3. **Evaluate the change:**
   - Is the new output visually better? (routing avoids crowded areas)
   - Are all nodes and labels still correct?
   - Is the change due to synthetic waypoints (large offset edges)?

4. **Update expectation or fix bug:**
   - If better: Update the expected output in the test
   - If worse: There's a bug in the implementation

### Expected Changes

| Fixture | Expected Change | Reason |
|---------|-----------------|--------|
| `complex.mmd` | Eâ†’F edge routing | Large horizontal offset, right-side source |
| `decision.mmd` | Possibly some edges | Depends on layout |
| `simple.mmd` | None expected | Small diagram, no large offsets |
| `chain.mmd` | None expected | Linear chain, no horizontal offsets |
| `shapes.mmd` | None expected | Various shapes but centered |
| `labeled_edges.mmd` | Possibly some edges | Depends on layout |

### Snapshot Testing (if using insta)

If using insta for snapshot testing:

```bash
# Review all changed snapshots
cargo insta review

# Accept changes that are improvements
cargo insta accept
```

### Manual Test Updates

For tests with inline expected output:

```rust
#[test]
fn test_complex() {
    let input = include_str!("fixtures/complex.mmd");
    let output = render_to_string(input, &default_options());

    // Update this expected output
    let expected = r#"
        ... new expected output ...
    "#;

    assert_eq!(output.trim(), expected.trim());
}
```

## Fixtures to Test

Run and visually inspect each:

```bash
for f in tests/fixtures/*.mmd; do
    echo "=== $f ==="
    cargo run -q -- "$f"
    echo
done
```

## Test Coverage Verification

After updates, verify:

```bash
# All tests pass
cargo test --test integration

# All unit tests pass
cargo test --lib

# Full test suite
cargo test
```

## Acceptance Criteria

- [ ] All integration tests pass
- [ ] Test expectations updated for diagrams with improved routing
- [ ] No unexpected regressions in simple diagrams
- [ ] Visual inspection confirms all fixtures render correctly
- [ ] Changes documented (which tests changed and why)
