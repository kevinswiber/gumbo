# Task 2.3: Update `assign_rank_minmax` for Title Rank

## Objective
Make `assign_rank_minmax()` use the title node's rank as `min_rank` for titled compounds, so that the compound span includes the title rank and `add_segments()` creates border nodes at it.

## Location
Modify: `src/dagre/nesting.rs` (`assign_rank_minmax()`)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_assign_rank_minmax_uses_title_rank_for_min() {
    let mut g: DiGraph<(f64, f64)> = DiGraph::new();
    g.add_node("A", (10.0, 10.0));
    g.add_node("B", (10.0, 10.0));
    g.add_node("sg1", (0.0, 0.0));
    g.add_edge("A", "B");
    g.set_parent("A", "sg1");
    g.set_parent("B", "sg1");
    g.set_has_title("sg1");
    let mut lg = LayoutGraph::from_digraph(&g, |_, dims| *dims);
    let sg1_idx = lg.node_index[&"sg1".into()];

    run(&mut lg);
    rank::run(&mut lg);
    rank::normalize(&mut lg);
    cleanup(&mut lg);
    assign_rank_minmax(&mut lg);

    let title_idx = lg.border_title[&sg1_idx];
    let top_idx = lg.border_top[&sg1_idx];

    // min_rank should be the title's rank, not border_top's rank
    assert_eq!(lg.min_rank[&sg1_idx], lg.ranks[title_idx]);
    // title rank should be strictly less than border_top rank
    assert!(lg.ranks[title_idx] < lg.ranks[top_idx]);
}
```

**What the failing test asserts:** `min_rank` uses the title node's rank (which is above border_top).
**Expected failure reason:** `assign_rank_minmax()` only looks at `border_top` for min_rank.

### ðŸŸ¢ Green: Minimal Implementation

Modify `assign_rank_minmax()`:

```rust
pub fn assign_rank_minmax(lg: &mut LayoutGraph) {
    let compound_indices: Vec<usize> = lg.compounds.iter().copied().collect();
    for compound_idx in compound_indices {
        // Use title rank if available, otherwise border_top
        if let Some(&title_idx) = lg.border_title.get(&compound_idx) {
            lg.min_rank.insert(compound_idx, lg.ranks[title_idx]);
        } else if let Some(&top_idx) = lg.border_top.get(&compound_idx) {
            lg.min_rank.insert(compound_idx, lg.ranks[top_idx]);
        }
        if let Some(&bot_idx) = lg.border_bottom.get(&compound_idx) {
            lg.max_rank.insert(compound_idx, lg.ranks[bot_idx]);
        }
    }
}
```

### ðŸ”µ Refactor: Clean Up

Verify that `add_segments()` now creates border_left/right nodes at the title rank (because min_rank is lower). This is implicit â€” `add_segments()` uses `min_rank..=max_rank`.

## Context
See [Q2 research](../../../research/0023-subgraph-title-arrow-collision/layout-level-structural-fix/q2-border-ordering-impact.md) â€” border segments are created for every rank in `[min_rank, max_rank]`. Using the title rank as min_rank ensures borders exist at that rank.

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] `assign_rank_minmax()` uses title rank for min_rank when present
- [ ] Title rank < border_top rank verified in test
- [ ] Untitled compounds still use border_top for min_rank
- [ ] All existing tests pass
