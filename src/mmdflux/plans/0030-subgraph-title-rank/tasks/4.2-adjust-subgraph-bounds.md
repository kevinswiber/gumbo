# Task 4.2: Adjust `convert_subgraph_bounds()` for Title Space

## Objective
Extend the top y-bound of subgraph bounds to account for the title rank's vertical space. The render layer independently computes bounds from member-node positions, which don't include the title dummy node.

## Location
Modify: `src/render/layout.rs` (`convert_subgraph_bounds()`)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_subgraph_bounds_title_extends_top() {
    use crate::graph::build_diagram;
    use crate::parser::parse_flowchart;

    // Subgraph with title
    let titled = "graph TD\nsubgraph sg1[Group]\nA --> B\nend\n";
    let ft = parse_flowchart(titled).unwrap();
    let dt = build_diagram(&ft);
    let lt = compute_layout_direct(&dt, &LayoutConfig::default());
    let titled_bounds = &lt.subgraph_bounds["sg1"];

    // The titled subgraph should have more space above the topmost node
    // Look at the gap between the subgraph top and the first node
    let a_pos = lt.draw_positions.iter()
        .find(|(k, _)| k.contains("A"))
        .map(|(_, v)| *v)
        .unwrap();

    // With title: node should be at least 4 rows below subgraph top
    // (border_padding=2 + title_extra=2)
    let gap = a_pos.1 as i32 - titled_bounds.y as i32;
    assert!(
        gap >= 4,
        "Titled subgraph top gap should be >= 4, got {} (node_y={}, bounds_y={})",
        gap, a_pos.1, titled_bounds.y
    );
}
```

**What the failing test asserts:** Titled subgraph bounds extend far enough above the topmost node to accommodate the title.
**Expected failure reason:** `convert_subgraph_bounds()` only uses `border_padding` (2), not accounting for title space.

### ðŸŸ¢ Green: Minimal Implementation

In `convert_subgraph_bounds()`, after computing `min_y` from member positions:

```rust
let border_padding = 2;
let title_extra = if !sg.title.is_empty() { 2 } else { 0 };
// title_extra: 1 row for title text + 1 row spacing below title
let border_y = min_y.saturating_sub(border_padding + title_extra);
```

This shifts the top border up by 2 extra rows for titled subgraphs.

### ðŸ”µ Refactor: Clean Up

- Consider deriving `title_extra` from `v_spacing` rather than hardcoding 2
- Verify the title text rendering in `render_subgraph_borders()` still aligns with the new bounds
- Check that the title-width adjustment (x-axis) still works correctly

## Context
See [Q4 research](../../../research/0023-subgraph-title-arrow-collision/layout-level-structural-fix/q4-bounds-extraction.md):
- `remove_nodes()` in dagre handles the title rank automatically
- `convert_subgraph_bounds()` independently recomputes from members and is the fix point
- The `border_padding = 2` is insufficient alone; `title_extra` adds dedicated title space

The title rank in dagre adds `rank_sep` (50.0 float) â†’ `v_spacing` (~3 chars) of vertical space. The `title_extra = 2` in the render layer accounts for this in the bounds computation. The exact value may need empirical tuning in Phase 5.

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] `convert_subgraph_bounds()` adds title-extra space for titled subgraphs
- [ ] Untitled subgraphs unchanged (title_extra = 0)
- [ ] Test passes
- [ ] Title text still renders correctly in the top border
