# Task 5.1: Extended Edge Syntax

## Objective

Expand the flowchart edge grammar to support variable-length edges, bidirectional arrows, and cross/circle arrow heads. This aligns with the upstream Jison grammar's full edge syntax.

## Location

Modify: `src/parser/grammar.pest`
Modify: `src/parser/ast.rs` (ConnectorSpec redesign)
Modify: `src/parser/flowchart.rs` (parse tree walker)
Modify: `src/graph/edge.rs` (Arrow enum expansion)

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_long_solid_edge() {
    let fc = parse_flowchart("graph TD\nA ----> B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.stroke, StrokeSpec::Solid);
    assert!(edge.connector.length > 2); // longer than default
}

#[test]
fn test_bidirectional_arrow() {
    let fc = parse_flowchart("graph TD\nA <--> B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.left, ArrowHead::Normal);
    assert_eq!(edge.connector.right, ArrowHead::Normal);
}

#[test]
fn test_cross_arrow_right() {
    let fc = parse_flowchart("graph TD\nA --x B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.right, ArrowHead::Cross);
}

#[test]
fn test_cross_arrow_both() {
    let fc = parse_flowchart("graph TD\nA x--x B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.left, ArrowHead::Cross);
    assert_eq!(edge.connector.right, ArrowHead::Cross);
}

#[test]
fn test_circle_arrow() {
    let fc = parse_flowchart("graph TD\nA --o B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.right, ArrowHead::Circle);
}

#[test]
fn test_circle_arrow_both() {
    let fc = parse_flowchart("graph TD\nA o--o B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.left, ArrowHead::Circle);
    assert_eq!(edge.connector.right, ArrowHead::Circle);
}

#[test]
fn test_long_dotted_edge() {
    let fc = parse_flowchart("graph TD\nA -...-> B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.stroke, StrokeSpec::Dotted);
}

#[test]
fn test_long_thick_edge() {
    let fc = parse_flowchart("graph TD\nA ====> B\n").unwrap();
    let edge = &fc.edges()[0];
    assert_eq!(edge.connector.stroke, StrokeSpec::Thick);
}
```

**What the failing tests assert:** Variable-length edges, bidirectional arrows, and cross/circle arrow heads parse into the correct AST types.
**Expected failure reason:** Current ConnectorSpec is a simple enum without arrow head types or length info.

### Green: Minimal Implementation

**New AST types:**
```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub enum ArrowHead {
    None,
    Normal,  // > or <
    Cross,   // x
    Circle,  // o
}

pub struct ConnectorSpec {
    pub stroke: StrokeSpec,
    pub left: ArrowHead,
    pub right: ArrowHead,
    pub length: usize,
    pub label: Option<String>,
}
```

**Grammar updates:**
```pest
arrow_left_head = { "<" | "x" | "o" }
arrow_right_head = { ">" | "x" | "o" }

// Solid: optional_left_head -- dashes -- optional_right_head
solid_link = { arrow_left_head? ~ "-" ~ "-"+ ~ arrow_right_head? }

// Dotted: optional_left_head - dots - optional_right_head
dotted_link = { arrow_left_head? ~ "-" ~ "."+ ~ "-" ~ arrow_right_head? }

// Thick: optional_left_head == equals == optional_right_head
thick_link = { arrow_left_head? ~ "=" ~ "="+ ~ arrow_right_head? }
```

This is a significant refactor since `ConnectorSpec` changes from enum to struct. All existing match sites need updating.

### Refactor: Clean Up

- Ensure existing `-->`, `-.->`, `==>`, `---` all still work
- Map ArrowHead to existing Arrow enum in graph layer
- Length calculation: count dashes/dots/equals to derive `minlen` for layout

## Context

The upstream Jison grammar uses regex patterns for edges:
- Solid: `[xo<]?\-\-+[-xo>]`
- Dotted: `[xo<]?\-\.\-+[xo>]` and similar
- Thick: `[xo<]?={2,}[xo>]`

This is the largest single task in the plan. Consider splitting into sub-tasks:
- 5.1a: Variable-length edges only (no new arrow heads)
- 5.1b: Cross/circle arrow heads
- 5.1c: Bidirectional arrows

See [research synthesis](../../../research/0026-mermaid-grammar-reference/synthesis.md) recommendation #2 about reading Jison actions.

## Acceptance Criteria

- [ ] Failing tests written and confirmed red
- [ ] ConnectorSpec redesigned as struct
- [ ] All existing edge tests still pass after refactor
- [ ] Variable-length edges parse with correct length
- [ ] Bidirectional arrows recognized
- [ ] Cross and circle arrow heads recognized
- [ ] Graph layer maps new arrow types appropriately
