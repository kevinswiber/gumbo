# Task 2.1: Add Additional Node Shapes to Pest Grammar

## Objective

Extend the flowchart Pest grammar to recognize all upstream Mermaid node shapes. Currently only Rectangle `[text]`, Round `(text)`, and Diamond `{text}` are supported.

## Location

Modify: `src/parser/grammar.pest`
Modify: `src/parser/ast.rs` (add ShapeSpec variants)
Modify: `src/parser/flowchart.rs` (parse tree walker for new shapes)

## TDD Phases

### Red: Write Failing Tests

Write a parse test for each new shape:

```rust
#[test]
fn test_parse_stadium_shape() {
    let fc = parse_flowchart("graph TD\nA([Stadium])\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Stadium(_))));
}

#[test]
fn test_parse_subroutine_shape() {
    let fc = parse_flowchart("graph TD\nA[[Subroutine]]\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Subroutine(_))));
}

#[test]
fn test_parse_cylinder_shape() {
    let fc = parse_flowchart("graph TD\nA[(Database)]\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Cylinder(_))));
}

#[test]
fn test_parse_circle_shape() {
    let fc = parse_flowchart("graph TD\nA((Circle))\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Circle(_))));
}

#[test]
fn test_parse_double_circle_shape() {
    let fc = parse_flowchart("graph TD\nA(((Double)))\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::DoubleCircle(_))));
}

#[test]
fn test_parse_hexagon_shape() {
    let fc = parse_flowchart("graph TD\nA{{Hexagon}}\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Hexagon(_))));
}

#[test]
fn test_parse_asymmetric_shape() {
    let fc = parse_flowchart("graph TD\nA>Flag]\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Asymmetric(_))));
}

#[test]
fn test_parse_trapezoid_shape() {
    let fc = parse_flowchart("graph TD\nA[/Trapezoid\\]\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::Trapezoid(_))));
}

#[test]
fn test_parse_inv_trapezoid_shape() {
    let fc = parse_flowchart("graph TD\nA[\\InvTrapezoid/]\n").unwrap();
    assert!(matches!(fc.vertices()[0].shape, Some(ShapeSpec::InvTrapezoid(_))));
}
```

**What the failing tests assert:** Each new shape delimiter is recognized and produces the correct ShapeSpec variant.
**Expected failure reason:** The grammar and AST don't define these shapes yet.

### Green: Minimal Implementation

**Grammar rules** (order matters -- more specific delimiters first):

```pest
// Text extractors for each shape
text_stadium = @{ (!"])" ~ ANY)+ }
text_subroutine = @{ (!"]]" ~ ANY)+ }
text_cylinder = @{ (!")]" ~ ANY)+ }
text_double_circle = @{ (!")))") ~ ANY)+ }
text_circle = @{ (!"))" ~ ANY)+ }
text_hexagon = @{ (!"}}" ~ ANY)+ }
text_asymmetric = @{ (!"]" ~ ANY)+ }
text_trapezoid = @{ (!"\\]" ~ ANY)+ }
text_inv_trapezoid = @{ (!"/]" ~ ANY)+ }

shape_double_circle = { "(((" ~ text_double_circle ~ ")))" }
shape_circle = { "((" ~ text_circle ~ "))" }
shape_stadium = { "([" ~ text_stadium ~ "])" }
shape_subroutine = { "[[" ~ text_subroutine ~ "]]" }
shape_cylinder = { "[(" ~ text_cylinder ~ ")]" }
shape_hexagon = { "{{" ~ text_hexagon ~ "}}" }
shape_asymmetric = { ">" ~ text_asymmetric ~ "]" }
shape_trapezoid = { "[/" ~ text_trapezoid ~ "\\]" }
shape_inv_trapezoid = { "[\\" ~ text_inv_trapezoid ~ "/]" }

// Updated shape rule - most specific first to avoid ambiguity
shape = {
    shape_double_circle | shape_circle | shape_stadium |
    shape_subroutine | shape_cylinder | shape_hexagon |
    shape_trapezoid | shape_inv_trapezoid |
    shape_asymmetric |
    shape_rect | shape_round | shape_diamond
}
```

**AST additions** in `ast.rs`:
```rust
pub enum ShapeSpec {
    Rectangle(String),
    Round(String),
    Diamond(String),
    Stadium(String),
    Subroutine(String),
    Cylinder(String),
    Circle(String),
    DoubleCircle(String),
    Hexagon(String),
    Asymmetric(String),
    Trapezoid(String),
    InvTrapezoid(String),
}
```

**Parse tree walker** in `flowchart.rs`: add match arms for each new `Rule::shape_*` variant.

### Refactor: Clean Up

- Verify existing Rectangle/Round/Diamond tests still pass
- Ensure PEG ordered-choice correctly disambiguates (e.g., `((` vs `(((`, `[` vs `[[` vs `[/` vs `[\`)
- Consider if text extractors need to handle nested delimiters or escapes

## Context

Upstream flowchart Jison grammar (`flow.jison`) defines all these shapes. They appear frequently in real diagrams (especially stadium for buttons/labels, cylinder for databases, hexagon for conditions).

Note: Rendering support for new shapes is **out of scope** for this task. New shapes will fall back to Rectangle rendering in Task 2.2.

## Acceptance Criteria

- [ ] Failing tests written for each new shape and confirmed red
- [ ] Grammar rules added with correct PEG ordering
- [ ] ShapeSpec enum extended with new variants
- [ ] Parse tree walker handles new variants
- [ ] All existing tests unaffected
- [ ] Shapes with similar delimiters correctly disambiguated
