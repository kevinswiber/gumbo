# Task 3.3: Integration Test for Fan Attachment Ordering

## Objective
Verify that fan-in patterns produce correctly ordered, non-crossing attachment points.

## Location
Modify: `tests/integration.rs` or `src/render/router.rs` (test module)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_fan_in_attachment_points_ordered() {
    let input = std::fs::read_to_string("tests/fixtures/fan_in.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    // Route all edges and collect target attachment x-coordinates for the target node
    let mut target_x_coords: Vec<usize> = Vec::new();
    for edge_layout in &layout.edges {
        let routed = route_edge(edge_layout, &layout, &config);
        target_x_coords.push(routed.end.x);
    }

    // Attachment x-coordinates should be strictly increasing (no duplicates, no crossings)
    for window in target_x_coords.windows(2) {
        assert!(window[0] < window[1],
            "Attachment points should be ordered: {} < {}", window[0], window[1]);
    }
}

#[test]
fn test_five_fan_in_no_overlap() {
    let input = std::fs::read_to_string("tests/fixtures/five_fan_in.mmd").unwrap();
    let flowchart = parse_flowchart(&input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    let mut attachment_points: Vec<(usize, usize)> = Vec::new();
    for edge_layout in &layout.edges {
        let routed = route_edge(edge_layout, &layout, &config);
        attachment_points.push((routed.end.x, routed.end.y));
    }

    // No two attachment points should be identical
    for i in 0..attachment_points.len() {
        for j in (i+1)..attachment_points.len() {
            assert_ne!(attachment_points[i], attachment_points[j],
                "Attachment points should not overlap");
        }
    }
}
```

**What the failing test asserts:** Fan-in edges have distinct, ordered attachment points.
**Expected failure reason:** Current sort may produce crossings for certain edge configurations.

### ðŸŸ¢ Green: Minimal Implementation

*(Tests should pass after Tasks 3.1 and 3.2)*

### ðŸ”µ Refactor: Clean Up

- Add similar test for `multiple_cycles.mmd` if backward edges cause issues

## Acceptance Criteria
- [ ] Fan-in attachment points are ordered
- [ ] No duplicate attachment points
- [ ] Five-fan-in renders cleanly
