# Task 3.1: Consistent Sort Key in `sort_face_group`

## Objective
Make face-group sorting consistent with face classification by sorting edges within a face group by their approach point's cross-axis coordinate.

## Location
Modify: `src/render/router.rs`, functions `compute_attachment_plan` (lines ~809-912) and `sort_face_group` (lines ~917-935)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_face_group_sort_matches_approach_order() {
    // Create a fan-in pattern with 3 sources at different x-positions
    // targeting the same node's top face
    // The sort order should match the approach x-coordinates, not the source centers
    let input = "graph TD\n    A --> D\n    B --> D\n    C --> D";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    // Get attachment plan for node D
    let plan = compute_attachment_plan(&layout, &config);

    // Edges arriving at D's top face should be sorted by their approach x-coordinate
    // (left-to-right matching source node positions)
    // Verify no crossings: for each adjacent pair, left edge's attachment x < right edge's attachment x
    // (detailed assertion depends on plan structure)
}

#[test]
fn test_backward_edge_face_sort_no_crossing() {
    // A backward edge and a forward edge share a face
    let input = "graph TD\n    A --> B\n    A --> C\n    C --> A";
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let layout = compute_layout_direct(&diagram, &config);

    let plan = compute_attachment_plan(&layout, &config);
    // The backward edge C-->A and forward edge A-->B/C should not cross at node A
}
```

**What the failing test asserts:** Face group sorting produces attachment points that don't cross.
**Expected failure reason:** Current sort uses opposite node center, which diverges from approach angle for backward edges.

### ðŸŸ¢ Green: Minimal Implementation

1. Modify `compute_attachment_plan` to store approach cross-axis coordinates alongside face group entries:

```rust
// Change face group value type from Vec<(usize, bool)> to include approach position
// (edge_index, is_source_side, approach_cross_axis)
type FaceEntry = (usize, bool, usize);
```

2. In the classification loop, capture the approach point's cross-axis coordinate:
   - For top/bottom faces: waypoint's x-coordinate
   - For left/right faces: waypoint's y-coordinate

3. In `sort_face_group`, sort by stored approach coordinate:

```rust
fn sort_face_group(entries: &mut [(usize, bool, usize)], face: NodeFace) {
    entries.sort_by_key(|&(_, _, approach_pos)| approach_pos);
}
```

### ðŸ”µ Refactor: Clean Up

- Remove the old sort logic that computed opposite-node centers
- Consider naming the tuple fields via a struct for clarity

## Context
- See [q3-attachment-point-ordering.md](../../../research/0013-visual-comparison-fixes/q3-attachment-point-ordering.md) for analysis
- The face classification (lines ~850-857) uses waypoint direction
- The sort (lines ~917-935) uses opposite node `center_x`/`center_y`
- These diverge for backward edges where the waypoint approaches from a different direction than the opposite node's center

## Acceptance Criteria
- [ ] Failing tests pass
- [ ] Fan-in patterns have no attachment crossings
- [ ] Backward edges don't cause crossing artifacts
