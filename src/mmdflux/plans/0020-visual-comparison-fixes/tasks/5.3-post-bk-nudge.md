# Task 5.3: Implement Post-BK Nudge Pass

## Objective
Add a pass after BK horizontal compaction that separates skip-edge dummy chains from adjacent real nodes.

## Location
Modify: `src/dagre/bk.rs` or `src/dagre/position.rs`

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

*(Tests from Task 5.2)*

### ðŸŸ¢ Green: Minimal Implementation

After `position_x()` returns coordinates, add a nudge pass:

```rust
fn nudge_skip_edges(graph: &LayoutGraph, xs: &mut HashMap<String, f64>, config: &LayoutConfig) {
    // 1. Identify dummy node chains (edges spanning 2+ ranks)
    //    Dummy nodes have IDs like "_d_edge_0_rank_2"
    let dummy_chains = find_dummy_chains(graph);

    // 2. For each chain, check if any dummy node's x is within edge_sep of an adjacent real node
    for chain in &dummy_chains {
        for dummy_id in chain {
            let dummy_x = xs[dummy_id];
            let dummy_rank = graph.node(dummy_id).rank;

            // Find real nodes on the same rank
            for (node_id, node) in graph.nodes() {
                if !node.is_dummy && node.rank == dummy_rank {
                    let node_x = xs[node_id];
                    let sep = (dummy_x - node_x).abs();
                    if sep < config.edge_sep as f64 {
                        // Nudge the entire chain away from this node
                        let nudge = config.edge_sep as f64 - sep;
                        let direction = if dummy_x >= node_x { nudge } else { -nudge };
                        for id in chain {
                            *xs.get_mut(id).unwrap() += direction;
                        }
                        break; // Only nudge once per chain
                    }
                }
            }
        }
    }
}
```

**Implementation note:** The exact approach depends on findings from Task 5.1. If the block graph approach is recommended, this implementation will be different (building block separation constraints into the compaction itself rather than post-processing).

### ðŸ”µ Refactor: Clean Up

- If the nudge creates new conflicts (nudging one chain into another node), add a second pass
- Consider making the nudge direction deterministic (always nudge to the right, or toward the edge's source)

## Context
- See [q2-bk-stagger-mechanism.md](../../../research/0013-visual-comparison-fixes/q2-bk-stagger-mechanism.md)
- Task 5.1 findings will inform whether this approach or a block graph is better
- `position_x()` is in `src/dagre/bk.rs`
- `find_dummy_chains()` needs to be implemented â€” dummy nodes are identifiable by name pattern

## Acceptance Criteria
- [ ] Skip edges have visual separation from intermediate nodes
- [ ] Tests from Task 5.2 pass
- [ ] No regressions in existing layout tests
