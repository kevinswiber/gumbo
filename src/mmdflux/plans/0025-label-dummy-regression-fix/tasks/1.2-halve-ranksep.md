# Task 1.2: Halve ranksep in scale factor computation

## Objective

When global minlen doubling is active (any edge has a label), halve the effective ranksep used in `compute_ascii_scale_factors()`. This compensates for the doubled rank count, keeping total diagram height approximately unchanged.

## Location

Modify: `src/render/layout.rs` â€” `compute_layout_direct()` (around lines 160-167 where dagre config is built, and 228-235 where scale factors are computed)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_scale_factors_halved_ranksep_for_labeled_diagrams() {
    // With rank_sep=50.0 and halving: effective rank_sep = 25.0
    // scale_y = (max_h + v_spacing) / (max_h + effective_rank_sep)
    //         = (3 + 3) / (3 + 25) = 6/28
    let mut dims = HashMap::new();
    dims.insert("A".into(), (9, 3));
    dims.insert("B".into(), (7, 3));

    let (_, sy) = compute_ascii_scale_factors(&dims, 25.0, 50.0, 3, 4, true);

    let expected_sy = 6.0 / 28.0;
    assert!(
        (sy - expected_sy).abs() < 1e-6,
        "sy: got {sy}, expected {expected_sy}"
    );
}
```

This test validates the math. The integration test in 1.3 validates the end-to-end behavior.

**What the failing test asserts:** Scale factors with halved ranksep produce correct values.
**Expected failure reason:** This test should pass immediately (it tests `compute_ascii_scale_factors` with explicit values). The real verification is that `compute_layout_direct()` passes the halved value â€” tested in 1.3.

### ðŸŸ¢ Green: Minimal Implementation

In `compute_layout_direct()`, after building edge_labels and before computing scale factors, introduce `effective_rank_sep`:

```rust
let has_labels = !edge_labels.is_empty();

// ... (dagre config uses rank_sep = 50.0 as normal) ...

// When global minlen doubling is active, halve ranksep for scale factor
// computation to compensate for the doubled rank count.
let effective_rank_sep = if has_labels {
    dagre_config.rank_sep / 2.0
} else {
    dagre_config.rank_sep
};

let (scale_x, scale_y) = compute_ascii_scale_factors(
    &node_dims, effective_rank_sep, dagre_config.node_sep,
    config.v_spacing, config.h_spacing, is_vertical,
);
```

### ðŸ”µ Refactor: Clean Up

- Consider extracting the `has_labels` flag earlier if it's used in multiple places (it will also be used in Phase 3)
- Ensure the comment explains the relationship between global minlen doubling and ranksep halving

## Context

- `compute_ascii_scale_factors()` at lines 499-524 computes `scale_primary = (max_primary + primary_spacing) / (max_primary + rank_sep)`
- The dagre layout engine itself keeps `rank_sep=50.0` â€” only the render-layer scale factor uses the halved value
- With minlenÃ—2, there are twice as many ranks. With ranksepÃ·2 in scale factors, each rank takes half the ASCII space. Net effect: approximately same total height.

## Acceptance Criteria

- [ ] Scale factor unit test passes with halved ranksep values
- [ ] `compute_layout_direct()` passes halved ranksep when labels present
- [ ] Label-free diagrams use original ranksep (no change)
- [ ] `cargo test` passes
