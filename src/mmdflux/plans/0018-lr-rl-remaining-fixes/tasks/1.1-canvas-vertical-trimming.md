# Task 1.1: Canvas Vertical Trimming

## Objective
Strip leading and trailing empty rows from canvas output, fixing the growing top margin in LR fan-out layouts (Issue 1).

## Location
Modify: `src/render/canvas.rs`

## TDD Cycle

### RED: Write failing tests

Add two tests in the existing `#[cfg(test)] mod tests` (line 231):

```rust
#[test]
fn test_canvas_trims_leading_empty_rows() {
    let mut canvas = Canvas::new(5, 5);
    // Content only on rows 2-3, leaving rows 0-1 empty above
    canvas.write_str(0, 2, "Hello");
    canvas.write_str(0, 3, "World");
    let output = canvas.to_string();
    // First line of output should be content, not blank
    assert_eq!(output, "Hello\nWorld");
}

#[test]
fn test_canvas_trims_trailing_empty_rows() {
    let mut canvas = Canvas::new(5, 5);
    // Content on rows 0-1, rows 2-4 empty below
    canvas.write_str(0, 0, "Hello");
    canvas.write_str(0, 1, "World");
    let output = canvas.to_string();
    assert_eq!(output, "Hello\nWorld");
}

#[test]
fn test_canvas_preserves_interior_empty_rows() {
    let mut canvas = Canvas::new(5, 4);
    // Content on rows 0 and 2, row 1 empty (interior gap)
    canvas.set(0, 0, 'A');
    canvas.set(0, 2, 'B');
    let output = canvas.to_string();
    assert_eq!(output, "A\n\nB");
}
```

**Run:** `cargo test --lib render::canvas::tests`

**Expected failures:**
- `test_canvas_trims_leading_empty_rows` — output starts with `"\n\n"` because leading empty rows are not stripped
- `test_canvas_trims_trailing_empty_rows` — output ends with `"\n\n\n"` because trailing empty rows are not stripped
- `test_canvas_preserves_interior_empty_rows` — this one should PASS already (confirms we don't break interior gaps)

**Verify:** The existing `test_canvas_to_string` (expects `"A   B\n\n  C"`) must still pass throughout.

### GREEN: Minimal implementation

In `Display::fmt()` (line 187), add vertical trimming after collecting lines and before computing `min_indent`. Insert between the line collection and the `min_indent` computation:

```rust
// Trim leading and trailing empty rows
let first_non_empty = lines.iter().position(|line| !line.is_empty()).unwrap_or(0);
let last_non_empty = lines
    .iter()
    .rposition(|line| !line.is_empty())
    .unwrap_or(lines.len().saturating_sub(1));
let lines = &lines[first_non_empty..=last_non_empty];
```

This re-binds `lines` as a slice of the original Vec, stripping empty rows from both ends.

**Run:** `cargo test --lib render::canvas::tests` — all tests should pass.

### REFACTOR

No refactoring expected — the change is a 4-line insertion. Verify full suite: `cargo test`.

## Context
- See [q1-canvas-top-margin.md](../../../research/0011-lr-rl-rendering-issues/q1-canvas-top-margin.md)

## Acceptance Criteria
- [ ] `test_canvas_trims_leading_empty_rows` fails before implementation, passes after
- [ ] `test_canvas_trims_trailing_empty_rows` fails before implementation, passes after
- [ ] `test_canvas_preserves_interior_empty_rows` passes before AND after (no behavior change)
- [ ] Existing `test_canvas_to_string` passes throughout
- [ ] `cargo test` passes
