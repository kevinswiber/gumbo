# Task 2.2: Direction-Aware Defaults for node_sep and edge_sep

## Objective
Compute direction-aware `node_sep` and `edge_sep` values for LR/RL layouts based on average node height, reducing the excessive vertical spacing (Issue 3).

## Location
Modify: `src/render/layout.rs` — `compute_layout_dagre()` function, lines 240-245

## TDD Cycle

### RED: Write failing test

Add a test in `src/render/layout.rs` in the existing `#[cfg(test)]` module (line 1222) that renders an LR fan-out and asserts the vertical spacing between targets is tight (not using the TD-calibrated 50.0 node_sep).

```rust
#[test]
fn test_lr_fanout_vertical_spacing() {
    use crate::graph::{Diagram, Direction, Edge, Node};

    let mut diagram = Diagram::new(Direction::LeftRight);
    diagram.add_node(Node::new("A").with_label("A"));
    diagram.add_node(Node::new("B").with_label("B"));
    diagram.add_node(Node::new("C").with_label("C"));
    diagram.add_node(Node::new("D").with_label("D"));
    diagram.add_edge(Edge::new("A", "B"));
    diagram.add_edge(Edge::new("A", "C"));
    diagram.add_edge(Edge::new("A", "D"));

    let config = LayoutConfig::default();
    let layout = compute_layout(&diagram, &config);

    // Get the Y positions of B, C, D
    let b_pos = layout.nodes.get("B").expect("B should exist");
    let c_pos = layout.nodes.get("C").expect("C should exist");
    let d_pos = layout.nodes.get("D").expect("D should exist");

    // Targets should be vertically ordered: B above C above D (or some ordering)
    let mut ys: Vec<usize> = vec![b_pos.y, c_pos.y, d_pos.y];
    ys.sort();

    // With direction-aware node_sep, vertical gaps should be small.
    // Node height is 3 (single-char label), so gaps between adjacent targets
    // should be <= 4 lines (node height + small padding).
    // With the old node_sep=50.0 this would be much larger.
    let gap_01 = ys[1] - ys[0];
    let gap_12 = ys[2] - ys[1];
    assert!(
        gap_01 <= 6,
        "Gap between first two targets is {} lines, expected <= 6 with direction-aware spacing",
        gap_01
    );
    assert!(
        gap_12 <= 6,
        "Gap between last two targets is {} lines, expected <= 6 with direction-aware spacing",
        gap_12
    );
}
```

**Run:** `cargo test --lib render::layout::tests::test_lr_fanout_vertical_spacing`

**Expected failure:** Gaps will be much larger than 6 because `node_sep=50.0` is still being used for LR.

### GREEN: Minimal implementation

In `compute_layout_dagre()` (layout.rs, lines 240-245), replace the hardcoded values:

```rust
let (node_sep, edge_sep) = match dagre_direction {
    DagreDirection::LeftRight | DagreDirection::RightLeft => {
        let total_height: f64 = dgraph
            .nodes()
            .iter()
            .filter_map(|(id, _)| {
                diagram.nodes.get(&id.0).map(|node| {
                    let (_, h) = node_dimensions(node);
                    h as f64
                })
            })
            .sum();
        let count = diagram.nodes.len().max(1) as f64;
        let avg_height = total_height / count;
        let ns = (avg_height * 2.0).max(6.0);
        let es = (avg_height * 0.8).max(2.0);
        (ns, es)
    }
    _ => (50.0, 20.0),
};

let dagre_config = DagreConfig {
    direction: dagre_direction,
    node_sep,
    edge_sep,
    rank_sep: 50.0,
    margin: 10.0,
    acyclic: true,
};
```

**Run:** `cargo test --lib render::layout::tests::test_lr_fanout_vertical_spacing` — should pass.

### REFACTOR

Run `cargo test` to verify no TD/BT regressions. The match only changes the LR/RL path, so TD/BT should be unaffected.

## Context
- Depends on task 2.1 (edge_sep field must exist in LayoutConfig)
- `node_dimensions()` is already available in `layout.rs`
- The `nodesep` variable at line 335 reads from `dagre_config.node_sep` and flows through to stagger scaling automatically
- See [q4-lr-centering-and-spacing.md](../../../research/0011-lr-rl-rendering-issues/q4-lr-centering-and-spacing.md)

## Acceptance Criteria
- [ ] `test_lr_fanout_vertical_spacing` fails before implementation, passes after
- [ ] TD/BT layouts unchanged (full `cargo test` passes)
