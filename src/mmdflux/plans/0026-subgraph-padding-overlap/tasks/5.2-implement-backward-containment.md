# Task 5.2: Expand Subgraph Bounds for Backward Edge Routing

## Objective
Detect backward edges within subgraphs and expand the subgraph border to contain the backward edge routing path.

## Location
Modify: `/Users/kevin/src/mmdflux-subgraphs/src/render/layout.rs` â€” `convert_subgraph_bounds()`

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

Tests from Task 5.1 should already be failing.

### ðŸŸ¢ Green: Minimal Implementation

In `convert_subgraph_bounds()`, after computing bounds, check for backward edges:

```rust
// Check for backward edges within this subgraph
let has_backward_edge = diagram.edges.iter().any(|e| {
    let from_in_sg = sg.nodes.contains(&e.from);
    let to_in_sg = sg.nodes.contains(&e.to);
    if !(from_in_sg && to_in_sg) { return false; }

    // A backward edge goes from a lower rank to a higher rank
    // In draw coordinates, check if the source is below the target (TD)
    // or to the right of the target (LR)
    if let (Some(from_pos), Some(to_pos)) = (
        draw_positions.get(&e.from),
        draw_positions.get(&e.to),
    ) {
        match direction {
            Direction::TopDown => from_pos.1 > to_pos.1,
            Direction::BottomTop => from_pos.1 < to_pos.1,
            Direction::LeftRight => from_pos.0 > to_pos.0,
            Direction::RightLeft => from_pos.0 < to_pos.0,
        }
    } else {
        false
    }
});

if has_backward_edge {
    // Expand border to contain backward routing path
    // The router places backward edges BACKWARD_ROUTE_GAP cells
    // to the right (TD/BT) or below (LR/RL) of the rightmost/bottommost node
    let route_margin = 4; // BACKWARD_ROUTE_GAP + buffer
    match direction {
        Direction::TopDown | Direction::BottomTop => {
            width += route_margin;
        }
        Direction::LeftRight | Direction::RightLeft => {
            height += route_margin;
        }
    }
}
```

Note: Read the actual `BACKWARD_ROUTE_GAP` constant from `router.rs` to get the correct value. The expansion should match the router's actual path offset.

### ðŸ”µ Refactor: Clean Up

- Extract backward-edge detection into a helper function
- Pass `direction` and `diagram.edges` to `convert_subgraph_bounds()` (add parameters)
- Use the actual router constant instead of hardcoded `4`
- Consider whether the expansion should be asymmetric (only expand the side where the backward route goes)

## Context
- Backward edge routing is in `src/render/router.rs`
- The route goes to the right of nodes in TD/BT, below in LR/RL
- `BACKWARD_ROUTE_GAP` or similar constant defines the offset
- See [Q3: Overlap inventory](../../../research/0019-subgraph-padding-overlap/q3-overlap-inventory.md) Issue 7

## Acceptance Criteria
- [ ] Backward edges detected within subgraphs
- [ ] Border expanded to contain backward routing path
- [ ] Expansion uses actual router constants
- [ ] Task 5.1 test passes
- [ ] `convert_subgraph_bounds()` signature updated to accept direction/edges
- [ ] Refactored and clean
