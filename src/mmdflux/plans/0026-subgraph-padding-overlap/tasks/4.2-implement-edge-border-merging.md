# Task 4.2: Implement Border-Aware Connection Merging

## Objective
When edges cross subgraph borders, merge the border's implicit connections with the edge's connections to produce proper junction characters.

## Location
Modify: `/Users/kevin/src/mmdflux-subgraphs/src/render/chars.rs` â€” add `infer_connections()`
Modify: `/Users/kevin/src/mmdflux-subgraphs/src/render/canvas.rs` â€” update `set_with_connection()`

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

Tests from Task 4.1 should already be failing.

### ðŸŸ¢ Green: Minimal Implementation

**1. Add `infer_connections()` to CharSet** (`chars.rs`):

```rust
impl CharSet {
    pub fn infer_connections(&self, ch: char) -> Connections {
        if ch == self.horizontal { Connections::left_right() }
        else if ch == self.vertical { Connections::up_down() }
        else if ch == self.corner_tl { Connections::new(false, true, false, true) } // down+right
        else if ch == self.corner_tr { Connections::new(false, true, true, false) } // down+left
        else if ch == self.corner_bl { Connections::new(true, false, false, true) } // up+right
        else if ch == self.corner_br { Connections::new(true, false, true, false) } // up+left
        else if ch == self.tee_down { Connections::new(false, true, true, true) }   // left+right+down
        else if ch == self.tee_up { Connections::new(true, false, true, true) }     // left+right+up
        else if ch == self.tee_right { Connections::new(true, true, false, true) }  // up+down+right
        else if ch == self.tee_left { Connections::new(true, true, true, false) }   // up+down+left
        else if ch == self.cross { Connections::all() }
        else { Connections::none() }
    }
}
```

Note: Adjust `Connections` constructor to match actual API. May need `Connections { up, down, left, right }` or similar.

**2. Update `set_with_connection()`** (`canvas.rs`):

In the existing code, before applying the new connections, check if the cell is a subgraph border and infer its connections:

```rust
pub fn set_with_connection(&mut self, x: usize, y: usize, ch: char, connections: Connections, charset: &CharSet) {
    let cell = &mut self.grid[y][x];

    if cell.is_node {
        return; // Don't overwrite nodes
    }

    // If overwriting a subgraph border, infer its connections first
    if cell.is_subgraph_border {
        let border_connections = charset.infer_connections(cell.ch);
        cell.connections.merge(border_connections);
        cell.is_subgraph_border = false; // Now becomes an edge/junction cell
    }

    cell.connections.merge(connections);
    cell.ch = charset.junction(cell.connections);
    cell.is_edge = true;
}
```

### ðŸ”µ Refactor: Clean Up

- Verify the `Connections` merge semantics (should be union/OR of all directions)
- Test with ASCII charset too
- Consider if this should also handle edge-over-edge merging (probably already works)

## Context
- The `Connections` struct tracks up/down/left/right connectivity for junction resolution
- `charset.junction()` maps a `Connections` to the appropriate box-drawing character
- See [Q3: Overlap inventory](../../../research/0019-subgraph-padding-overlap/q3-overlap-inventory.md) Issues 4, 9

## Acceptance Criteria
- [ ] `infer_connections()` added to CharSet for all box-drawing characters
- [ ] `set_with_connection()` infers border connections before merging edge connections
- [ ] Edge crossing horizontal border produces `â”¼` (or appropriate junction)
- [ ] Task 4.1 tests pass
- [ ] Refactored and clean
