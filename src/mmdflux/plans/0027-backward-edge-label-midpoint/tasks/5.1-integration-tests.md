# Task 5.1: Integration Tests for All Directions

## Objective

Add integration tests verifying backward edge label placement across all four layout directions (TD, BT, LR, RL). Strengthen the existing `labeled_backward_edge_renders` test.

## Location

Modify: `~/src/mmdflux-label-dummy/tests/integration.rs`

## TDD Phases

### üî¥ Red: Write Failing Tests

```rust
#[test]
fn backward_edge_label_position_td() {
    // In TD, backward edges route to the right
    let output = render_input("graph TD\n    A --> B\n    B -->|retry| A");
    assert!(output.contains("retry"), "Label missing:\n{output}");
    // Label should be to the right of the node column area
    let lines: Vec<&str> = output.lines().collect();
    let retry_line = lines.iter().find(|l| l.contains("retry")).unwrap();
    let retry_col = retry_line.find("retry").unwrap();
    // Retry should not overlap with the node boxes (which are typically < col 15)
    // This is a structural assertion ‚Äî the exact threshold depends on node width
    assert!(retry_col > 5, "Label should be positioned away from left edge:\n{output}");
}

#[test]
fn backward_edge_label_position_bt() {
    let output = render_input("graph BT\n    A --> B\n    B -->|retry| A");
    assert!(output.contains("retry"), "Label missing:\n{output}");
}

#[test]
fn backward_edge_label_position_lr() {
    // In LR, backward edges route below
    let output = render_input("graph LR\n    A --> B\n    B -->|retry| A");
    assert!(output.contains("retry"), "Label missing:\n{output}");
}

#[test]
fn backward_edge_label_position_rl() {
    let output = render_input("graph RL\n    A --> B\n    B -->|retry| A");
    assert!(output.contains("retry"), "Label missing:\n{output}");
}

#[test]
fn backward_and_forward_labels_coexist() {
    let output = render_input("graph TD\n    A -->|go| B\n    B -->|retry| A");
    assert!(output.contains("go"), "Forward label missing:\n{output}");
    assert!(output.contains("retry"), "Backward label missing:\n{output}");
}

#[test]
fn backward_edge_label_does_not_overlap_nodes() {
    let output = render_input("graph TD\n    Start --> End\n    End -->|back| Start");
    assert!(output.contains("back"), "Label missing:\n{output}");
    // The label "back" should not overlap with the node box characters
    let lines: Vec<&str> = output.lines().collect();
    for line in &lines {
        if line.contains("back") {
            // The line with the label should not also contain box-drawing node borders
            // at the same position as the label
            let back_pos = line.find("back").unwrap();
            let before_label = &line[..back_pos];
            // There should be whitespace or edge characters before the label, not node box chars
            assert!(
                !before_label.ends_with("‚îÇ") && !before_label.ends_with("‚îê"),
                "Label overlaps with node box:\n{output}"
            );
        }
    }
}
```

**What the tests assert:** Backward edge labels appear in the output and are positioned appropriately for each layout direction.
**Expected failure reason:** After Phase 4, these should pass. Write them first to verify.

### üü¢ Green: Verify Tests Pass

These tests should pass after Phase 4 implementation. If any fail, adjust the rendering integration.

### üîµ Refactor: Clean Up

- Strengthen the existing `labeled_backward_edge_renders` test (integration.rs:1025) to check positioning, not just existence.
- Extract helper functions for common assertions (e.g., `assert_label_in_output`, `find_label_position`).
- Run the full test suite to verify no regressions: `cargo test --test integration`
- Also test with existing fixtures that have backward edges: `labeled_edges.mmd`, `git_workflow.mmd`, `http_request.mmd`

## Context

- `render_input()` is a test helper in `tests/integration.rs` that parses, builds, and renders a mermaid string.
- Existing backward edge label test is at `integration.rs:1025-1033`.
- Fixtures with backward edges: `tests/fixtures/labeled_edges.mmd`, `tests/fixtures/simple_cycle.mmd`, `tests/fixtures/multiple_cycles.mmd`.

## Acceptance Criteria

- [ ] Tests for all four directions (TD, BT, LR, RL) added
- [ ] Tests for coexistence of forward and backward labels
- [ ] Tests for label-node non-overlap
- [ ] Existing `labeled_backward_edge_renders` test strengthened
- [ ] All integration tests pass
- [ ] No regressions in existing tests
