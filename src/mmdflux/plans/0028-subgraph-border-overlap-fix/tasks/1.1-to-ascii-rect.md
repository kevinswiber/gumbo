# Task 1.1: Add `to_ascii_rect()` with unit tests

## Objective
Create a method on `TransformContext` that correctly transforms dagre center-based `Rect` values to draw-coordinate bounding boxes, using the same formula as the node position pipeline.

## Location
Modify: `src/render/layout.rs` â€” add method to `TransformContext` impl block, add unit tests

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

Write these tests first:

```rust
#[cfg(test)]
mod to_ascii_rect_tests {
    use super::*;
    use crate::dagre::types::Rect;

    #[test]
    fn test_rect_at_dagre_minimum() {
        // A rect centered at the dagre minimum should produce draw coords near origin + padding
        let ctx = TransformContext {
            dagre_min_x: 50.0,
            dagre_min_y: 30.0,
            scale_x: 0.2,
            scale_y: 0.1,
            overhang_x: 2,
            overhang_y: 1,
            padding: 1,
            left_label_margin: 0,
        };
        let rect = Rect { x: 50.0, y: 30.0, width: 40.0, height: 20.0 };
        let (x, y, w, h) = ctx.to_ascii_rect(&rect);
        // Verify the rect is placed correctly and has reasonable dimensions
        assert!(w > 0);
        assert!(h > 0);
    }

    #[test]
    fn test_rect_offset_from_minimum() {
        // A rect offset from dagre minimum should have proportionally offset draw coords
        let ctx = TransformContext {
            dagre_min_x: 0.0,
            dagre_min_y: 0.0,
            scale_x: 0.2,
            scale_y: 0.1,
            overhang_x: 0,
            overhang_y: 0,
            padding: 0,
            left_label_margin: 0,
        };
        let rect1 = Rect { x: 50.0, y: 50.0, width: 40.0, height: 20.0 };
        let rect2 = Rect { x: 100.0, y: 100.0, width: 40.0, height: 20.0 };
        let (x1, y1, _, _) = ctx.to_ascii_rect(&rect1);
        let (x2, y2, _, _) = ctx.to_ascii_rect(&rect2);
        // rect2 should be further right and down
        assert!(x2 > x1);
        assert!(y2 > y1);
    }
}
```

**What the failing test asserts:** The `to_ascii_rect()` method exists and produces correct draw coordinates for dagre Rects.
**Expected failure reason:** `to_ascii_rect()` does not exist yet.

### ðŸŸ¢ Green: Minimal Implementation

Add to `TransformContext`:

```rust
/// Transform a dagre center-based Rect to draw coordinates (x, y, width, height).
/// Uses the same right-edge offset formula as the node position pipeline.
pub fn to_ascii_rect(&self, rect: &Rect) -> (usize, usize, usize, usize) {
    // Scale center using right-edge offset (matches node formula)
    let scaled_cx = ((rect.x + rect.width / 2.0 - self.dagre_min_x) * self.scale_x).round() as usize;
    let scaled_cy = ((rect.y + rect.height / 2.0 - self.dagre_min_y) * self.scale_y).round() as usize;

    // Scale extent
    let scaled_w = (rect.width * self.scale_x).round().max(1.0) as usize;
    let scaled_h = (rect.height * self.scale_y).round().max(1.0) as usize;

    // Apply overhang and compute top-left
    let center_x = scaled_cx + self.overhang_x;
    let center_y = scaled_cy + self.overhang_y;
    let draw_x = center_x.saturating_sub(scaled_w / 2) + self.padding + self.left_label_margin;
    let draw_y = center_y.saturating_sub(scaled_h / 2) + self.padding;

    (draw_x, draw_y, scaled_w, scaled_h)
}
```

### ðŸ”µ Refactor: Clean Up

- Consider whether `TransformContext` fields need to be public or if the struct should be constructed via a builder
- Add doc comment explaining the right-edge offset formula and why it differs from `to_ascii()`
- Check for any code duplication with the node position formula in `compute_layout()`

## Context

The `TransformContext` struct is defined around line 845 of `layout.rs`. It currently has a `to_ascii()` method for point transformations. The new `to_ascii_rect()` method handles Rect (bounding box) transformations using the center-based formula.

Key difference from `to_ascii()`: the node position formula adds `rect.width/2.0` before scaling (lines 303-304), which `to_ascii()` does not. This is the root cause of the coordinate mismatch documented in Plan 0026 findings.

See [Q4: Coordinate Transformation Fix](../../../research/0021-subgraph-border-overlap-deep-dive/q4-coordinate-transformation-fix.md) for full mathematical derivation.

## Acceptance Criteria
- [ ] Failing tests written and confirmed red
- [ ] `to_ascii_rect()` implemented and tests pass
- [ ] Method handles edge cases (zero-width rect, rect at dagre minimum)
- [ ] Code refactored with tests still green
