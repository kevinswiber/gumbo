# Task 5.1: Fix ASCII Coordinate Transform for Labels

## Objective
Ensure label positions from the dagre layout are correctly transformed to ASCII canvas coordinates and land within canvas bounds.

## Location
Modify: `src/render/layout.rs` â€” `transform_label_positions_direct()` or equivalent

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

```rust
#[test]
fn test_label_position_within_canvas_bounds() {
    let input = r#"graph TD
    A -->|yes| B"#;
    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let layout = compute_layout(&diagram, &RenderConfig::default());

    // Label position should exist and be within canvas bounds
    assert!(!layout.edge_label_positions.is_empty(),
        "Should have precomputed label positions");

    for (_, pos) in &layout.edge_label_positions {
        assert!(pos.row >= 0, "Label row should be non-negative");
        assert!(pos.col >= 0, "Label col should be non-negative");
        // Should be within reasonable canvas bounds
    }
}
```

**What the failing test asserts:** Precomputed label positions are present in the Layout output and within canvas bounds.
**Expected failure reason:** The coordinate transform may produce out-of-bounds positions, or the label positions may not be populated at all for short edges (before this plan's changes).

### ðŸŸ¢ Green: Minimal Implementation

Debug and fix `transform_label_positions_direct()`:
- Ensure it uses `layer_starts` for the primary axis (same as waypoint transform)
- Handle label dummy positions that are at intermediate ranks (between real node ranks)
- Ensure the transform produces valid canvas coordinates

### ðŸ”µ Refactor: Clean Up

- Consolidate label position transform with waypoint transform if they share logic
- Remove any dead code paths for label position computation

## Context
- `compute_layout_direct()` in `src/render/layout.rs` calls `transform_label_positions_direct()`
- The transform converts dagre floating-point coordinates to integer canvas cell positions
- `layer_starts` maps rank indices to canvas row/col positions
- The current transform may simply round dagre coordinates, which doesn't account for the canvas grid structure

## Acceptance Criteria
- [ ] Failing test written and confirmed red
- [ ] Label positions correctly transformed to canvas coordinates
- [ ] All precomputed positions are within canvas bounds
- [ ] Positions are accurate (label appears near the edge midpoint)
