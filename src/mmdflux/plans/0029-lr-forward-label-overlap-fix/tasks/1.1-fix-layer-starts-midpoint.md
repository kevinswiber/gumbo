# Task 1.1: Fix `layer_starts` Odd-Rank Interpolation Using Layer Right Edges

## Objective

Change the odd-rank `layer_starts` interpolation formula to compute midpoints between the **right edge** of the source layer and the **left edge** of the target layer, instead of left-edge-to-left-edge. This places label dummy positions in the gap between nodes rather than inside the source node.

## Location

Modify: `src/render/layout.rs` â€” `compute_layout_direct()`, around lines 396-434 (layer_starts computation)

## TDD Phases

### ðŸ”´ Red: Write Failing Tests

Add a test that renders `git_workflow.mmd` and asserts the forward edge labels are fully visible (not clipped by node boundaries):

```rust
#[test]
fn git_workflow_forward_labels_visible() {
    let output = render_fixture("git_workflow.mmd");
    // Forward edge labels should be fully visible, not clipped
    assert!(
        output.contains("git commit"),
        "Forward label 'git commit' should be fully visible:\n{output}"
    );
    assert!(
        output.contains("git push"),
        "Forward label 'git push' should be fully visible:\n{output}"
    );
    assert!(
        output.contains("git add"),
        "Forward label 'git add' should be fully visible:\n{output}"
    );
}
```

**What the failing test asserts:** All three forward edge labels appear in the rendered output as complete strings.
**Expected failure reason:** The current `layer_starts` midpoint places labels inside source nodes, where `is_node` cell protection clips them. Only fragments like "mmit" appear.

### ðŸŸ¢ Green: Minimal Implementation

1. After the existing `layer_starts_raw` computation (which collects the min primary-axis coordinate per layer), add a parallel `layer_ends_raw` computation that collects the max primary-axis coordinate **plus width** (i.e., right edge for LR, bottom edge for TD):

```rust
// Compute max right/bottom edge per layer
let layer_ends_raw: Vec<usize> = layers
    .iter()
    .map(|layer| {
        layer
            .iter()
            .filter_map(|id| {
                let &(x, y) = draw_positions.get(id)?;
                let &(w, h) = node_dims.get(id)?;
                if is_vertical {
                    Some(y + h)
                } else {
                    Some(x + w)
                }
            })
            .max()
            .unwrap_or(0)
    })
    .collect();
```

2. Modify the odd-rank branch of `layer_starts` construction to use `layer_ends_raw` for the source:

```rust
// Before (wrong â€” uses left edge of source layer):
// let curr = layer_starts_raw.get(layer_idx).copied().unwrap_or(0);
// let next = layer_starts_raw.get(layer_idx + 1).copied().unwrap_or(curr);
// (curr + next) / 2

// After (correct â€” uses right edge of source layer):
let curr_end = layer_ends_raw.get(layer_idx).copied().unwrap_or(0);
let next_start = layer_starts_raw.get(layer_idx + 1).copied().unwrap_or(curr_end);
(curr_end + next_start) / 2
```

### ðŸ”µ Refactor: Clean Up

- Consider bundling `layer_starts_raw` and `layer_ends_raw` into a `LayerBounds` struct or computing them together in a single pass over layers
- Add a comment explaining why right-edge-to-left-edge is correct for odd-rank interpolation
- Run full test suite to verify no regressions

## Context

The `layer_starts` array maps dagre ranks to draw coordinates. Even ranks correspond to real node layers, odd ranks to label dummy positions between layers. The current formula uses left-edge midpoints which works when nodes are narrow, but fails when wide nodes cause the midpoint to fall inside the source node.

For git_workflow.mmd (LR):
- Staging Area at x=30, width=16, right edge=46
- Local Repo at x=60
- Current midpoint: (30+60)/2 = 45 (inside Staging, extends to 46)
- Fixed midpoint: (46+60)/2 = 53 (in the 14-char gap)

See [Research 0022 Q2](../../../research/0022-lr-forward-label-overlap/q2-node-boundary-analysis.md) for detailed analysis.

## Acceptance Criteria

- [ ] Failing test written and confirmed red
- [ ] `layer_ends_raw` computation added
- [ ] Odd-rank interpolation uses `layer_ends_raw` for source layer
- [ ] `git_workflow.mmd` forward labels ("git add", "git commit", "git push") are fully visible
- [ ] Stray segment (`â”€â”´â”€`) no longer appears (side effect of correct midpoint)
- [ ] TD/BT layout fixtures (`labeled_edges.mmd`, `label_spacing.mmd`) still pass
- [ ] Full `cargo test` passes
