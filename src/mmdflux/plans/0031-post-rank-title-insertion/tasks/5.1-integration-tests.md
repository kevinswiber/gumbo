# Task 5.1: Integration Tests for Multi-Subgraph Titles

## Objective

Add integration tests that verify the end-to-end rendering of titled subgraphs, including the multi-subgraph case that originally triggered the rank collision. Update any existing snapshot tests that change due to the title rank space.

## Location

Modify: `tests/integration.rs`
May create: `tests/fixtures/multi_subgraph_titled.mmd` (if not covered by existing fixtures)

## TDD Phases

### Red: Write Failing Tests

```rust
#[test]
fn test_render_titled_subgraph_shows_title() {
    let input = r#"graph TD
    subgraph sg1[Processing]
        A[Step 1] --> B[Step 2]
    end"#;
    let output = render_str(input);

    // Title should appear in the rendered output
    assert!(
        output.contains("Processing"),
        "Output should contain subgraph title 'Processing':\n{}",
        output
    );
    // Nodes should also appear
    assert!(output.contains("Step 1"));
    assert!(output.contains("Step 2"));
}

#[test]
fn test_render_multi_subgraph_titled_no_garble() {
    let input = r#"graph TD
    subgraph sg1[Input]
        A[Read] --> B[Parse]
    end
    subgraph sg2[Output]
        C[Format] --> D[Write]
    end
    A --> C"#;
    let output = render_str(input);

    // Both titles should appear
    assert!(
        output.contains("Input"),
        "Output should contain 'Input' title:\n{}", output
    );
    assert!(
        output.contains("Output"),
        "Output should contain 'Output' title:\n{}", output
    );
    // All nodes should appear
    assert!(output.contains("Read"));
    assert!(output.contains("Parse"));
    assert!(output.contains("Format"));
    assert!(output.contains("Write"));

    // No garbled characters (basic check: no stray box-drawing characters
    // outside of node borders and subgraph borders)
    // This is a sanity check — visual inspection is also needed
}

#[test]
fn test_render_titled_subgraph_title_not_overwritten_by_edge() {
    // This is the original collision scenario:
    // External node connects to a node inside a titled subgraph.
    // The edge should not overwrite the title text.
    let input = r#"graph TD
    D[External] --> A
    subgraph sg1[Processing]
        A[Internal] --> B[Next]
    end"#;
    let output = render_str(input);

    assert!(
        output.contains("Processing"),
        "Title should not be overwritten by edge:\n{}", output
    );
    assert!(output.contains("External"));
    assert!(output.contains("Internal"));
}
```

**Expected failure reason:** Without Phases 1-4 complete, the render output won't have title rank separation, so the title may be overwritten by edges or the tests may fail on title presence.

### Green: Verify Tests Pass

After Phases 1-4 are complete, these tests should pass. If any fail:
- Check that `set_has_title()` is being called in the render layer
- Check that `convert_subgraph_bounds()` has the title_extra padding
- Visually inspect the rendered output for layout issues

### Refactor: Update Existing Snapshots

Run all integration tests. If any existing snapshot tests produce different output due to the title rank space:
1. Visually inspect the new output to confirm it's correct
2. Update the expected output to match

Check fixtures that use subgraph titles:
- `tests/fixtures/subgraph_edges.mmd` — may have titles
- Any other fixtures with `subgraph name[Title]` syntax

## Context

The `render_str()` helper (if it exists) or equivalent parses, builds, and renders a diagram to a string. Check `tests/integration.rs` for the actual test infrastructure.

The key collision scenario: `D[External] --> A` where A is inside `subgraph sg1[Processing]`. The edge from D to A passes through the subgraph border. Without title rank separation, the edge waypoint overwrites the "Processing" title text.

## Acceptance Criteria

- [ ] Integration test for single titled subgraph
- [ ] Integration test for multi-subgraph with cross-edges
- [ ] Integration test for external-to-internal edge (collision scenario)
- [ ] All existing integration tests pass (snapshots updated if needed)
- [ ] Visual inspection of rendered output confirms no garbling
