# Task 3.1: Update Existing Nesting and Ordering Tests

## Objective

Update tests that assumed title nodes are created during `nesting::run()` to use the new pipeline sequence (title created post-rank via `insert_title_nodes()`).

## Location

Modify: `src/dagre/nesting.rs` — test module
Modify: `src/dagre/order.rs` — test module

## TDD Phases

### Red: Identify Failing Tests

Run `cargo test` after tasks 1.1 and 2.1/2.2. These tests will fail:

1. **`test_nesting_run_adds_title_node_for_titled_compound`** (nesting.rs) — asserts `border_title` is populated after `run()`. Now it won't be.

2. **`test_assign_rank_minmax_uses_title_rank_for_min`** (nesting.rs) — calls `run` + `rank::run` + `rank::normalize` + `cleanup` + `assign_rank_minmax` but doesn't call `insert_title_nodes()`. So `border_title` is empty and the test fails.

3. **`test_compound_ordering_single_child_rank_has_borders`** (order.rs) — if it calls `set_has_title()` and expects title nodes during the pipeline, it needs `insert_title_nodes()`.

### Green: Update Tests

**1. Replace `test_nesting_run_adds_title_node_for_titled_compound`:**

```rust
#[test]
fn test_titled_compound_gets_title_node_after_insert() {
    use crate::dagre::rank;

    let mut lg = build_test_titled_compound_layout_graph();
    let sg1_idx = lg.node_index[&"sg1".into()];

    run(&mut lg);
    rank::run(&mut lg);
    rank::normalize(&mut lg);
    cleanup(&mut lg);
    insert_title_nodes(&mut lg);

    assert!(lg.border_title.contains_key(&sg1_idx));
    let title_idx = lg.border_title[&sg1_idx];
    assert_eq!(lg.node_ids[title_idx], NodeId::from("_tt_sg1"));
}
```

**2. Update `test_assign_rank_minmax_uses_title_rank_for_min`:**

Add `insert_title_nodes(&mut lg);` between `cleanup` and `assign_rank_minmax`:

```rust
#[test]
fn test_assign_rank_minmax_uses_title_rank_for_min() {
    use crate::dagre::rank;

    let mut lg = build_test_titled_compound_layout_graph();
    let sg1_idx = lg.node_index[&"sg1".into()];

    run(&mut lg);
    rank::run(&mut lg);
    rank::normalize(&mut lg);
    cleanup(&mut lg);
    insert_title_nodes(&mut lg);  // NEW
    assign_rank_minmax(&mut lg);

    let title_idx = lg.border_title[&sg1_idx];
    let top_idx = lg.border_top[&sg1_idx];

    assert_eq!(lg.min_rank[&sg1_idx], lg.ranks[title_idx]);
    assert!(lg.ranks[title_idx] < lg.ranks[top_idx]);
}
```

**3. Update ordering test** (if applicable):

Check `test_compound_ordering_single_child_rank_has_borders` in `order.rs`. If it uses `set_has_title()`, add `insert_title_nodes()` to its pipeline sequence.

### Refactor: Clean Up

- Consider extracting a helper for the full compound pipeline sequence:
  ```rust
  fn run_compound_pipeline(lg: &mut LayoutGraph) {
      run(lg);
      rank::run(lg);
      rank::normalize(lg);
      cleanup(lg);
      insert_title_nodes(lg);
      assign_rank_minmax(lg);
  }
  ```
  Only do this if the pattern repeats 3+ times.

## Context

The `build_test_titled_compound_layout_graph()` helper creates `sg1` with `set_has_title("sg1")`. The `build_test_compound_layout_graph()` helper creates `sg1` without a title.

## Acceptance Criteria

- [ ] All three (or more) failing tests identified
- [ ] Tests updated with correct pipeline sequence
- [ ] `cargo test` passes with zero failures
- [ ] No test logic changes beyond pipeline sequence updates
