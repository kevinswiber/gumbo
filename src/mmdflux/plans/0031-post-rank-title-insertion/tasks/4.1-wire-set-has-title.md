# Task 4.1: Wire `set_has_title()` in Render Layer

## Objective

Call `dgraph.set_has_title()` for subgraphs with non-empty titles in `compute_layout_direct()`, activating the title rank system for the first time.

## Location

Modify: `src/render/layout.rs` — `compute_layout_direct()` function, in the subgraph setup section

## TDD Phases

### Red: Write Failing Test

```rust
#[test]
fn test_titled_subgraph_creates_title_rank() {
    let input = r#"graph TD
    subgraph sg1[Processing]
        A[Step 1] --> B[Step 2]
    end"#;

    let flowchart = parse_flowchart(input).unwrap();
    let diagram = build_diagram(&flowchart);
    let config = RenderConfig::default();
    let layout = compute_layout(&diagram, &config);

    // The subgraph bounds should exist
    assert!(layout.subgraph_bounds.contains_key("sg1"));

    // With title rank active, the subgraph should have additional
    // vertical space compared to an untitled subgraph
    let bounds = &layout.subgraph_bounds["sg1"];
    assert!(bounds.height > 0);
}
```

This test may pass without changes if the layout completes without error. The real verification is whether the dagre layout includes a title rank. A more precise test:

```rust
#[test]
fn test_titled_subgraph_has_title_rank_in_dagre_output() {
    use crate::dagre::{self, DiGraph, LayoutConfig as DagreConfig};

    let mut graph: DiGraph<(f64, f64)> = DiGraph::new();
    graph.add_node("sg1", (0.0, 0.0));
    graph.add_node("A", (40.0, 20.0));
    graph.add_node("B", (40.0, 20.0));
    graph.add_edge("A", "B");
    graph.set_parent("A", "sg1");
    graph.set_parent("B", "sg1");
    graph.set_has_title("sg1");

    let config = DagreConfig::default();
    let result = dagre::layout(&graph, &config, |_, dims| *dims);

    // Subgraph bounds should reflect the title rank
    let bounds = &result.subgraph_bounds["sg1"];
    let a_rect = &result.nodes[&"A".into()];

    // The subgraph top should be above node A (title + border_top + padding)
    assert!(bounds.y < a_rect.y, "Subgraph top {} should be above node A {}", bounds.y, a_rect.y);
}
```

**Expected failure reason:** `set_has_title()` is not called in the render layer, so `compound_titles` is empty, and no title nodes are created in the dagre pipeline.

### Green: Minimal Implementation

In `compute_layout_direct()`, find where subgraph nodes are added to the `DiGraph` and add `set_has_title()`:

```rust
// Find the subgraph setup loop and add set_has_title:
for (sg_id, sg) in &diagram.subgraphs {
    // ... existing node addition ...
    if !sg.title.is_empty() {
        dgraph.set_has_title(sg_id.as_str());
    }
}
```

The exact location depends on how `compute_layout_direct()` currently adds subgraph nodes. Read the function to find the right insertion point.

### Refactor: Clean Up

None expected — this is a small addition.

## Context

`diagram.subgraphs` is a `HashMap<String, Subgraph>` where `Subgraph` has a `title: String` field. Empty title means the subgraph was declared without `[Title]` syntax.

`set_has_title()` on `DiGraph` adds the node to `compound_titles`, which is transferred to `LayoutGraph` by `from_digraph()`.

## Acceptance Criteria

- [ ] Failing test written and confirmed red
- [ ] `set_has_title()` called for titled subgraphs in render layer
- [ ] Dagre layout output reflects title rank
- [ ] All existing tests still pass
